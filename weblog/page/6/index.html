<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	
	


	<link href='https://fonts.googleapis.com/css?family=PT+Sans+Caption:400,700' rel='stylesheet' type='text/css'>
	<link rel="alternate" type="application/rss+xml" title="Ben Dodson, iOS Developer" href="https://bendodson.com/rss.xml" />
	<link rel="stylesheet" href="/styles-2021-03-10.css" />
	<link rel="stylesheet" href="/highlight-2018-02-23.css" />
	<link rel="icon" href="https://bendodson.s3.amazonaws.com/bendodson.com/favicon.ico">
	<link rel="apple-touch-icon" href="https://bendodson.s3.amazonaws.com/bendodson.com/touch-icon-iphone.png">
	<link rel="apple-touch-icon" sizes="76x76" href="https://bendodson.s3.amazonaws.com/bendodson.com/touch-icon-ipad.png">
	<link rel="apple-touch-icon" sizes="120x120" href="https://bendodson.s3.amazonaws.com/bendodson.com/touch-icon-iphone-retina.png">
	<link rel="apple-touch-icon" sizes="152x152" href="https://bendodson.s3.amazonaws.com/bendodson.com/touch-icon-ipad-retina.png">
	<link rel="apple-touch-icon" sizes="180x180" href="https://bendodson.s3.amazonaws.com/bendodson.com/touch-icon-ipad-retina.png">
	<title>Ben Dodson's Blog &mdash; Freelance Swift and Apple Platforms Developer</title>
</head>
<body>

	<div id="wrapper">

		<header>
			<hgroup>
				<h1><a href="/">Ben Dodson</a></h1>
				<h2>Freelance iOS, macOS, Apple Watch, and Apple TV Developer</h2>
			</hgroup>
			<nav>
				<ul>
					<li><a href="/">Home</a></li><li><a href="/weblog/">Blog</a></li><li><a href="/about/">About</a></li><li><a href="/clients/">Portfolio</a></li><li><a href="/apps/">My Apps</a></li><li><a href="/projects/">Projects</a></li><li><a href="/contact/">Contact</a></li>
				</ul>
				<div class="divider"></div>
			</nav>
		</header>

		<section id="posts">

	
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/07/10/passwordless-user-accounts-within-ios-apps/">Creating passwordless user accounts within iOS apps</a></h1>
			
			<time datetime="2016-07-10" pubdate=""><a href="/weblog/2016/07/10/passwordless-user-accounts-within-ios-apps/">July 10, 2016</a></time>
    	</header>
    	<div>
			<p>I’m currently in the process of writing an app which will store some information for each user on a server; the stored data should be available to the user on all of their devices. Usually there are two ways of dealing with this:</p>

<ol>
  <li>
    <p>Build a user access system such that the user has to register to use the service. They’ll need to log in to the app (usually with email address and password) on each of their devices.</p>
  </li>
  <li>
    <p>Use CloudKit to store all of the information in an Apple provided database.</p>
  </li>
</ol>

<p>The first option is overkill for this fairly simple app<sup id="fnref:overkill" role="doc-noteref"><a href="#fn:overkill" class="footnote" rel="footnote">1</a></sup> and the second is too restrictive as it means I need to use Apple’s specific data modelling system. However, there is a third way which uses a bit of each of them…</p>

<p>When a user is logged in to an Apple account on their device<sup id="fnref:appleaccount" role="doc-noteref"><a href="#fn:appleaccount" class="footnote" rel="footnote">2</a></sup>, they are automatically signed into the iCloud system. With CloudKit, every app gets its own identifier based on both the CloudKit container and user account which doesn’t change. By retrieving this identifier, you can be 100% sure of the user that is using your app without knowing anything personal about them and without requiring them to manually log into your app.</p>

<p>To get the identifier, you first need to enable CloudKit within the iCloud section of the Capabilities panel in Xcode (which will require updating your provisioning profile). Then, it is a simple case of importing the CloudKit framework and using the following code:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">let</span> <span class="nv">container</span> <span class="o">=</span> <span class="kt">CKContainer</span><span class="o">.</span><span class="nf">defaultContainer</span><span class="p">()</span>
<span class="n">container</span><span class="o">.</span><span class="n">fetchUserRecordIDWithCompletionHandler</span> <span class="p">{</span> <span class="p">(</span><span class="n">recordID</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">recordID</span> <span class="o">=</span> <span class="n">recordID</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kt">NSLog</span><span class="p">(</span><span class="s">"Error: </span><span class="se">\(</span><span class="n">error</span><span class="s">")
        return
    }
    
    NSLog("</span><span class="kt">Identifier</span><span class="p">:</span> <span class="p">\(</span><span class="n">recordID</span><span class="o">.</span><span class="n">recordName</span><span class="p">)</span><span class="s">")    
}</span></code></pre></figure>

<p>The identifier returned will be 34 characters long and look something like this:</p>

<p><code class="language-plaintext highlighter-rouge">_e990774f93dd6625b11af6d40fceb310</code></p>

<p>Once you have that, you can then send it to your server to match it against whatever content you want to link to this particular user. Now whenever they use your app on any device with the same Apple account, they’ll have access to everything without the need for a manual account creation process and without having to hand over any personal information. The entire process is completely silent and is very secure as the identifier is generated from both the Apple account and your CloudKit container - it can’t be used by other apps nor can it be reverse-engineered to give you personal details of the user.</p>

<p>I find the code above a bit messy to be used multiple times throughout an application (not to mention the <code class="language-plaintext highlighter-rouge">import CloudKit</code> requirement) and so I’ve wrapped this up in a very basic Swift class that can be called as such:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kt">AppleCloudIdentifier</span><span class="o">.</span><span class="n">fetch</span> <span class="p">{</span> <span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">identifier</span> <span class="o">=</span> <span class="n">identifier</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kt">NSLog</span><span class="p">(</span><span class="s">"Error: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    
    <span class="kt">NSLog</span><span class="p">(</span><span class="s">"Cloud identifier: </span><span class="se">\(</span><span class="n">identifier</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>I’ve named it <code class="language-plaintext highlighter-rouge">AppleCloudIdentifier</code> and the code is <a href="https://github.com/bendodson/AppleCloudIdentifier">available on GitHub</a>.</p>

<p><strong>UPDATE [3rd May 2019]:</strong> I needed use of this in a recent project and so I’ve updated the code to make use of Swift 5 and the new <code class="language-plaintext highlighter-rouge">Result</code> type.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:overkill" role="doc-endnote">
      <p>It’ll also lead to a sharp drop-off in users as people don’t like having to create multiple accounts all over the place. You could implement something like Facebook Login but then you still have an issue in that you are requiring a fair amount of personal information upfront which you probably don’t need. <a href="#fnref:overkill" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:appleaccount" role="doc-endnote">
      <p>I’ll hazard a guess that 99.9% of iOS devices are logged into an Apple account. They need to be in order to download apps, send iMessages, create backups, etc, so very unlikely you wouldn’t be. <a href="#fnref:appleaccount" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/06/15/divide-14-wwdc-2016-itunes-with-tabs/">The Divide #14 - WWDC 2016, 'iTunes with tabs'</a></h1>
			
			<time datetime="2016-06-15" pubdate=""><a href="/weblog/2016/06/15/divide-14-wwdc-2016-itunes-with-tabs/">June 15, 2016</a></time>
    	</header>
    	<div>
			<p>The <a href="http://thedivide.co.uk/episodes/14">14th episode of The Divide podcast</a> is now available in which we take look at the new announcements about watchOS, tvOS, macOS, and iOS in a special episode almost as long as the WWDC keynote itself. We also have a brief chat about the latest news from E3 and Chris gets upset about the Stay Puft Marshmallow Man.</p>

<p>You can get The Divide from these fine outlets:</p>

<ul>
  <li><a href="https://itunes.apple.com/gb/podcast/the-divide/id1063410638">iTunes</a></li>
  <li><a href="https://overcast.fm/itunes1063410638/the-divide">Overcast</a></li>
  <li><a href="http://thedivide.co.uk/shows/itunes.xml">RSS</a> (for other podcast readers)</li>
  <li><a href="http://thedivide.co.uk/">The Divide website</a></li>
</ul>

<p>Don’t forget to leave a review on iTunes and follow us on Twitter via <a href="http://twitter.com/PodcastDivide">@PodcastDivide</a>.</p>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/06/07/ios-10-wishlist/">iOS 10 Wishlist</a></h1>
			
			<time datetime="2016-06-07" pubdate=""><a href="/weblog/2016/06/07/ios-10-wishlist/">June 07, 2016</a></time>
    	</header>
    	<div>
			<p>I was recently interviewed by Fast Company for an article they wrote about iOS features they’d like to see at WWDC this year. A couple of my suggestions were <a href="http://www.fastcompany.com/3060377/wwdc/10-ios-features-wed-love-to-see-apple-announce-at-wwdc">featured in the article</a> but I thought I’d publish my full iOS 10 wishlist.</p>

<h3 id="system-defaults">System Defaults</h3>
<p>One of the things that I feel has been long missing from iOS is the ability to choose a default app for certain tasks such as email, web browser, phone, or notes. I would love to see a way for developers to make their app conform to some set of standards that would allow them to be selected as a default app. For example, Skype could conform to the “phone app” standard so when you tap a phone number in your mail app it’ll launch Skype and dial the number rather than using the Phone app. Similarly, email links could go to Polymail and web links to Chrome.</p>

<h3 id="siri-api">Siri API</h3>
<p>I’ve long wanted a full API for Siri but so far there hasn’t even been a stepping stone. I imagine the first phase would go hand in hand with the System Defaults plan I outlined and that apps that adopt a certain standard would be able to show up in Siri. For example, if Spotify conformed to being a “music app” then saying “<em>Hey Siri, Play C’est La Via by B*Witched</em>” would start that track playing in Spotify rather than Music.</p>

<h3 id="control-center-buttons">Control Center Buttons</h3>
<p>When you swipe up from the bottom of the screen on iOS, you get Control Center which gives you quick access to certain features (like WiFi), controls (for music / video), and apps (Torch, Timer, etc). I’d like the ability to a) use 3D touch to get more options when using the features section (so I can choose a new WiFi network) and b) be able to choose the apps and features that show up in that area. I never need quick access to the calculator.</p>

<h3 id="carplay">CarPlay</h3>
<p>I’ve been using CarPlay for around a year now (via an after market <a href="http://www.alpine.co.uk/p/Products/digital-media-receiver-4660/ilx-700">Alpine iLX-700</a>) and I absolutely love it. However, 3rd party apps are limited to a few selected audio apps like Spotify and Overcast which use a simple template that doesn’t work very well. I’d like to see support for any 3rd party app to use CarPlay and for it to use UIKit so that any interface can be displayed. <a href="https://twitter.com/bendodson/status/712573913977524224">I noticed in March</a> that iOS 9.3 added a <code class="language-plaintext highlighter-rouge">UIUserInterfaceIdiom</code> for CarPlay so hopefully this is coming.</p>

<h3 id="airplay">AirPlay</h3>
<p>I have a number of AirPlay devices around the house and one of the things that frustrates me most is that I can’t use Siri to control them. I’d like to be able to say “Hey Siri, play my cooking playlist in the kitchen” and have it just work. I’ve been able to <a href="https://bendodson.com/weblog/2016/05/24/homekit-and-airplay/">hack this functionality together</a> via some Applescript and a fake HomeKit setup on my Mac called Homebridge but it’d be nice to have it built in natively. Also, iTunes on the Mac can AirPlay to multiple speakers at once whereas iOS can’t.</p>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/05/25/divide-13-consoles/">The Divide #13 - Consoles</a></h1>
			
			<time datetime="2016-05-25" pubdate=""><a href="/weblog/2016/05/25/divide-13-consoles/">May 25, 2016</a></time>
    	</header>
    	<div>
			<p>The <a href="http://thedivide.co.uk/episodes/13">13th episode of The Divide podcast</a> is now available in which we discuss video game consoles from our first tentative steps in the 8-bit era to the almost HD consoles of the modern day. We also discuss the Flic button, Day of the Tentacle, the Nvidia GTX 1080, Stellaris, and our predictions for WWDC.</p>

<p>You can get The Divide from these fine outlets:</p>

<ul>
  <li><a href="https://itunes.apple.com/gb/podcast/the-divide/id1063410638">iTunes</a></li>
  <li><a href="https://overcast.fm/itunes1063410638/the-divide">Overcast</a></li>
  <li><a href="http://thedivide.co.uk/shows/itunes.xml">RSS</a> (for other podcast readers)</li>
  <li><a href="http://thedivide.co.uk/">The Divide website</a></li>
</ul>

<p>Don’t forget to leave a review on iTunes and follow us on Twitter via <a href="http://twitter.com/PodcastDivide">@PodcastDivide</a>.</p>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/05/24/homekit-and-airplay/">HomeKit, AirPlay, and controlling iTunes with Siri</a></h1>
			
			<time datetime="2016-05-24" pubdate=""><a href="/weblog/2016/05/24/homekit-and-airplay/">May 24, 2016</a></time>
    	</header>
    	<div>
			<p>A few days ago I wrote an article about <a href="https://bendodson.com/weblog/2016/05/18/using-a-button-with-homekit-scenes/">getting my Flic button to work with HomeKit</a>. Since then, I’ve had a few requests from people wondering how I was getting iTunes to work with HomeKit such that it could start a playlist on some AirPlay speakers. Today I’ve <a href="https://www.npmjs.com/~bendodson#packages">released a couple of HomeBridge plugins to NPM</a> and I’ll detail how I’ve got my system working.</p>

<p>First of all, my entire setup is powered by the awesome <a href="https://github.com/nfarina/homebridge">Homebridge</a> system which I’ve written about <a href="https://www.google.co.uk/#q=site:bendodson.com+homebridge">at great length</a>. I found a plugin from <a href="https://github.com/dansays">Dan Budiac</a> called <a href="https://github.com/dansays/homebridge-applescript">homebridge-applescript</a> which allowed you to run a line of applescript via a system of fake switches (so a different script could be called when the switch is turned on and off). This is great for simple one-liners (like “<code class="language-plaintext highlighter-rouge">tell application iTunes to pause</code>”) but I needed something a bit longer for dealing with AirPlay. I <a href="https://github.com/bendodson/homebridge-applescript">forked Dan’s project</a> to create my own Homebridge plugin that would work with a path to an AppleScript file rather than a single line of AppleScript:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
	</span><span class="nl">"accessory"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ApplescriptFile"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Kitchen Music"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"on"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/Users/bendodson/Dropbox/Scripts/kitchenMusic.applescript"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"off"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/Users/bendodson/Dropbox/Scripts/stopMusic.applescript"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>This allowed me to then use my existing <a href="https://bendodson.com/weblog/2016/05/12/airplay-alarm-clock-with-itunes-12/">alarm clock script</a> in order to make iTunes connect to my kitchen speakers and play a specific playlist<sup id="fnref:twoplaylists" role="doc-noteref"><a href="#fn:twoplaylists" class="footnote" rel="footnote">1</a></sup> when my “kitchen speakers” switch is turned on and disconnect from AirPlay and pause iTunes when it is turned off.</p>

<p>This worked well but it has a few problems as the music is coming from a Mac in a different room; there is no way to change the volume, skip a track, or do a basic play / pause toggle<sup id="fnref:playpause" role="doc-noteref"><a href="#fn:playpause" class="footnote" rel="footnote">2</a></sup> without going upstairs to do it manually on iTunes. After thinking about it for a little while, I was able to get the track skipping and play /pause done fairly easily. First of all, I use the following config:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"accessory"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ApplescriptFile"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Music Play Pause Control"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"on"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/Users/bendodson/Dropbox/Scripts/playMusic.applescript"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"off"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/Users/bendodson/Dropbox/Scripts/pauseMusic.applescript"</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"accessory"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ApplescriptFile"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Music Track Control"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"on"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/Users/bendodson/Dropbox/Scripts/nextTrack.applescript"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"off"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/Users/bendodson/Dropbox/Scripts/previousTrack.applescript"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p><em>I won’t detail the AppleScript for each of these as they are fairly basic.</em></p>

<p>Next, I used the ‘Scenes’ feature of HomeKit to set up named scenes that related to each toggle. For example, “iTunes next track” is a scene that ensures the “Music Track Control” accessory is turned on whereas “iTunes previous track” ensures that accessory is off. The play / pause controls work in a similar way. Once activated, this meant I could say things like “<em>Hey Siri, iTunes next track</em>” or “<em>Hey Siri, pause iTunes</em>”.</p>

<p>Whilst scenes can be incredibly useful due to the ability to use any text you want, they can’t be used for something like volume where you want to use a specific amount<sup id="fnref:volumeamount" role="doc-noteref"><a href="#fn:volumeamount" class="footnote" rel="footnote">3</a></sup>. Unfortunately HomeKit doesn’t have the concept of speakers so there isn’t a way to naturally create an accessory that deals with volume so I improvised and created a fake lightbulb that controlled an AppleScript via the brightness property; <a href="https://github.com/bendodson/homebridge-applescript-file-lightbulb">homebridge-applescript-file-lightbulb</a><sup id="fnref:naming" role="doc-noteref"><a href="#fn:naming" class="footnote" rel="footnote">4</a></sup>.</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"accessory"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ApplescriptFileLightbulb"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"iTunes volume"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"on"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nl">"off"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nl">"brightness"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/Users/bendodson/Dropbox/Scripts/volume.applescript"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">volume.applescript</code> file looks like this:</p>

<figure class="highlight"><pre><code class="language-applescript" data-lang="applescript"><span class="k">on</span> <span class="nb">run</span><span class="w"> </span><span class="nv">argv</span><span class="w">
	</span><span class="k">set</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nb">item</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nv">argv</span><span class="w">
	</span><span class="nb">activate</span><span class="w"> </span><span class="nb">application</span><span class="w"> </span><span class="s2">"iTunes"</span><span class="w">
	</span><span class="k">tell</span><span class="w"> </span><span class="nb">application</span><span class="w"> </span><span class="s2">"iTunes"</span><span class="w">
		</span><span class="k">set</span><span class="w"> </span><span class="na">sound</span><span class="w"> </span><span class="na">volume</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nv">v</span><span class="w">
	</span><span class="k">end</span><span class="w"> </span><span class="k">tell</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="nb">run</span></code></pre></figure>

<p>With this in place, I can say “<em>Hey Siri, set iTunes volume to 50%</em>” and it will work. This is because lightbulbs have a brightness setting and Siri interprets “<em>set [name] to [percentage]</em>” as being “<em>change the brightness of this device</em>” just in this case we are hitting an AppleScript with our brightness value.
<img src="https://bendodson.s3.amazonaws.com/weblog/2016/siri-itunes-volume.jpg" width="375" height="375" />
This has been a fun little exercise in trying to hack HomeKit into what I want to use it for. I’m hopeful that iOS 10 will add native support for HomeKit speakers as then this could be done without reverting to AppleScript and I’d be able to stream from my iPhone via Siri but it’s pretty cool for the time being.</p>

<p>You can find both of my Homebridge plugins on <a href="https://www.npmjs.com/~bendodson#packages">NPM</a> and <a href="https://github.com/bendodson/">GitHub</a>.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:twoplaylists" role="doc-endnote">
      <p>Actually my own setup has two playlists. I have a playlist for Monday through Saturday with my music but on Sunday my wife gets up first so I have a different playlist for her. The code for that is <code class="language-plaintext highlighter-rouge">if weekday of (current date) is Sunday then</code> <a href="#fnref:twoplaylists" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:playpause" role="doc-endnote">
      <p>At first I’d get around this by just using “<em>turn off kitchen music</em>” followed by “<em>turn on kitchen music</em>” as the playlist was shuffled but hardly an ideal solution. <a href="#fnref:playpause" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:volumeamount" role="doc-endnote">
      <p>I could have done the same as the track control AppleScript and had a “iTunes volume up” and “iTunes volume down” scene to increase or decrease by 10% each time but that would be a pain if you wanted to change the volume by a large amount. <a href="#fnref:volumeamount" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:naming" role="doc-endnote">
      <p>I shouldn’t be allowed to name things. <a href="#fnref:naming" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/05/19/great-british-bee-count-2016/">Great British Bee Count 2016</a></h1>
			
			<time datetime="2016-05-19" pubdate=""><a href="/weblog/2016/05/19/great-british-bee-count-2016/">May 19, 2016</a></time>
    	</header>
    	<div>
			<p><a href="https://bendodson.com/weblog/2015/05/01/great-british-bee-count-app/">Last year</a> I worked on rebuilding the <a href="https://itunes.apple.com/gb/app/great-british-bee-count/id880987608?mt=8">Great British Bee Count iPhone app</a> for Friends of the Earth. Today, an updated version of the app has gone live to support this years count which runs from 19th May until 30th June 2016:</p>

<p><img src="https://bendodson.s3.amazonaws.com/weblog/2016/gbbc-2016.jpg" width="800" height="500" /></p>

<p>There are several updates including a redesigned bee picker, more details of the bees, and a list of plants suitable for attracting bees sponsored by Waitrose. The app is also now universal with support for both the iPhone and iPad<sup id="fnref:ipaduniversal" role="doc-noteref"><a href="#fn:ipaduniversal" class="footnote" rel="footnote">1</a></sup>.</p>

<p>You can check out the <a href="https://itunes.apple.com/gb/app/great-british-bee-count/id880987608?mt=8">Great British Bee Count on the App Store</a> (it’s free) or <a href="http://www.foe.co.uk/page/join-great-british-bee-count-today">learn more about the bee cause</a>.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:ipaduniversal" role="doc-endnote">
      <p>This came about due to a restriction in the App Store. If you search for an iPhone-only app on the iPad, you have to manually select “iPhone-only” when searching which nobody in their right mind does (as iPhone apps run on iPad just fine in a scaled mode). To make it so that searching “Great British Bee Count” on the iPad App Store would show the app, it had to be a universal app but the client didn’t want to have a custom design for the iPad but continue to use the iPhone scaling. There isn’t an elegant way to do that (as turning on Universal mode will cause AutoLayout to treat the iPad like an iPad) so I solved this by writing a custom view controller that would take the iPhone 4s XIB files and then simply scale them upwards with an affine transform. I also added an extra border on the sides that matches the yellow background to avoid the black boxing that the previous version had. This works great on all iPads (including the iPad Pro) but the text on some items is quite blurry on the non-retina iPad 2 due to a bug within the Apple Frameworks; it’s intelligent enough to use the retina imagery so that images look smooth but not on text apparently. <a href="#fnref:ipaduniversal" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/05/18/using-a-button-with-homekit-scenes/">Using a physical button (Flic) with HomeKit scenes and triggers</a></h1>
			
			<time datetime="2016-05-18" pubdate=""><a href="/weblog/2016/05/18/using-a-button-with-homekit-scenes/">May 18, 2016</a></time>
    	</header>
    	<div>
			<p>When I started out as a web developer I was fascinated by APIs; the ability to hook into other data sources or update other applications from my own had huge potential that is finally being realised with the Internet of Things<sup id="fnref:stuff" role="doc-noteref"><a href="#fn:stuff" class="footnote" rel="footnote">1</a></sup>. It is now possible to write apps that interact with physical objects via such things as <a href="http://ifttt.com/">IFTTT</a> or dedicated APIs for devices like the <a href="https://meethue.com/">Philips Hue</a>. I’ve personally been very interested in the <a href="http://www.apple.com/uk/ios/homekit/">HomeKit initiative</a> from Apple although it hasn’t really taken off yet.</p>

<p>Whilst I have a lot of internet connected devices, I currently own just a single HomeKit-compatible device; an <a href="https://www.elgato.com/en/eve/eve-door-window">Elgato eve door &amp; window</a> that lets me ask Siri if my back door is currently open<sup id="fnref:phrasing" role="doc-noteref"><a href="#fn:phrasing" class="footnote" rel="footnote">2</a></sup>. Luckily there is the <a href="https://github.com/nfarina/homebridge">Homebridge</a> project (which I’ve <a href="https://bendodson.com/weblog/2015/12/01/homekit-christmas-tree-with-siri/">written about previously</a>) that allows me to connect all of those together and use them as if they were native HomeKit devices.</p>

<p>Over the past few months, I’ve been <a href="https://bendodson.com/weblog/2016/03/23/homekit-wink-and-canary/">dabbling with HomeKit scenes</a> so that I can control groups of devices all at once like so:</p>

<blockquote>
  <p><strong>Good Morning</strong></p>

  <ul>
    <li>Turns on downstairs lights</li>
    <li>Starts playing my “morning” playlist in kitchen via AirPlay</li>
    <li>Disables security cameras</li>
  </ul>

  <p><strong>Good Night</strong></p>

  <ul>
    <li>Turns off all lights (including bedside table lamp)</li>
    <li>Stops any playing music</li>
    <li>Enables security cameras</li>
  </ul>
</blockquote>

<p>This has been working well but I frequently forget to use scenes as many of these things can be controlled in other ways. For example, I might turn off the downstairs lights with my Hue Dimmer Switch and then turn off the bedside table lamp via the Hue today widget which means I forget to activate the security cameras. The eventual solution I’ve come up with is a simple push button (from <a href="http://flic.io/">Flic</a>) stuck under my bedside table that toggles between my <em>Good Morning</em> and <em>Good Night</em> scenes. In this article, I’ll tell you how I did it!</p>

<p>First of all, you are going to need a <a href="http://flic.io/">Flic</a>. I did a lot of research on “smart buttons” and this one was far and away the best<sup id="fnref:biy" role="doc-noteref"><a href="#fn:biy" class="footnote" rel="footnote">3</a></sup>. It’s small, has a changeable battery (that lasts 18 months), looks good, and it has an iOS SDK complete with background Bluetooth LE support so you can wake your app up even if it is inactive. The amount of code necessary to support Flic is ridiculously small; you can take a look at <a href="https://flic.io/partners/developers/ios-tutorial">their iOS tutorial</a> to see it in more detail but essentially you will be kicking your user to the Flic app in order to assign a button to the app. Once you’re back, it’s a simple case of activating a singleton and listening for a <code class="language-plaintext highlighter-rouge">manager:didReceiveButtonDown</code> request.</p>

<p>With the button tested and working, I set to work on adding HomeKit support to my app. This is relatively straightforward although you do need to create a dedicated provisioning profile in order to add the necessary entitlements to your project. Within a few minutes, I had a toggle in my app that would toggle between my <em>Good Morning</em> and <em>Good Night</em> scenes. That was when disaster struck; the HomeKit APIs do not work when your app is not in the foreground<sup id="fnref:homekitforeground" role="doc-noteref"><a href="#fn:homekitforeground" class="footnote" rel="footnote">4</a></sup>.</p>

<p>This threw me for a little while until I decided that my app would simply have to connect directly to my mac and interface with the Homebridge software that was basically powering everything<sup id="fnref:rebuild" role="doc-noteref"><a href="#fn:rebuild" class="footnote" rel="footnote">5</a></sup>. After a quick search, I found <a href="https://github.com/cflurin/homebridge-websocket">Homebridge-websocket</a>, a plugin that basically adds a custom websocket server as a platform to HomeKit. You can create accessories (like a switch) within the websocket server and then you’ll get callbacks when they are turned on and off.</p>

<p>I planned to make use of this via a HomeKit property known as “triggers”. A trigger is basically a way for HomeKit to monitor a specific device for a specific value (i.e. when a switch is “on”). As soon as it sees that value, it will activate a chosen scene. I set this up by creating two new switches within Homebridge-websocket; <code class="language-plaintext highlighter-rouge">ws_morning</code> and <code class="language-plaintext highlighter-rouge">ws_evening</code>. I then set up two triggers within HomeKit; <code class="language-plaintext highlighter-rouge">WebSocket Morning</code> (which triggers the <em>Good Morning</em> scene when the <code class="language-plaintext highlighter-rouge">ws_morning</code> switch turns on) and <code class="language-plaintext highlighter-rouge">WebSocket Evening</code> (which triggers the <em>Good Night</em> scene when the <code class="language-plaintext highlighter-rouge">ws_evening</code> switch turns on). The only change I needed to make to my scenes was to ensure that both <code class="language-plaintext highlighter-rouge">ws_morning</code> and <code class="language-plaintext highlighter-rouge">ws_evening</code> are set to “off” when either is activated; this ensures that I can always turn them from “off” to “on” and thus cause the trigger.</p>

<p>The final step was to update my iOS app to talk to the websocket server instead of to Homebridge. I found a simple drop-in framework named <a href="https://github.com/daltoniam/Starscream">Starscream</a> which allowed me to connect to the server and send commands which led me to this code for the entire project:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="kt">UIKit</span>
<span class="kd">import</span> <span class="kt">Starscream</span>

<span class="k">let</span> <span class="nv">ipAddress</span> <span class="o">=</span> <span class="s">"192.168.1.100:4050"</span>
<span class="k">let</span> <span class="nv">flicAppKey</span> <span class="o">=</span> <span class="s">"Your-Flic-App-Key"</span>
<span class="k">let</span> <span class="nv">flicAppSecret</span> <span class="o">=</span> <span class="s">"Your-Flic-App-Secret"</span>

<span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UIViewController</span><span class="p">,</span> <span class="kt">SCLFlicButtonDelegate</span><span class="p">,</span> <span class="kt">SCLFlicManagerDelegate</span><span class="p">,</span> <span class="kt">WebSocketDelegate</span> <span class="p">{</span>

    <span class="k">let</span> <span class="nv">socket</span> <span class="o">=</span> <span class="kt">WebSocket</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">NSURL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"ws://</span><span class="se">\(</span><span class="n">ipAddress</span><span class="se">)</span><span class="s">/"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
    
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="kt">SCLFlicManager</span><span class="o">.</span><span class="nf">configureWithDelegate</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">defaultButtonDelegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">appID</span><span class="p">:</span> <span class="n">flicAppKey</span><span class="p">,</span> <span class="nv">appSecret</span><span class="p">:</span> <span class="n">flicAppSecret</span><span class="p">,</span> <span class="nv">backgroundExecution</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">setupFlic</span><span class="p">(</span><span class="nv">sender</span><span class="p">:</span> <span class="kt">AnyObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">SCLFlicManager</span><span class="o">.</span><span class="nf">sharedManager</span><span class="p">()?</span><span class="o">.</span><span class="nf">grabFlicFromFlicAppWithCallbackUrlScheme</span><span class="p">(</span><span class="s">"sceneControl"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">toggle</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">socket</span><span class="o">.</span><span class="nf">connect</span><span class="p">()</span>
    <span class="p">}</span>
    

    <span class="c1">// MARK: Flic Manager</span>
    
    <span class="kd">func</span> <span class="nf">flicManager</span><span class="p">(</span><span class="nv">manager</span><span class="p">:</span> <span class="kt">SCLFlicManager</span><span class="p">,</span> <span class="n">didGrabFlicButton</span> <span class="nv">button</span><span class="p">:</span> <span class="kt">SCLFlicButton</span><span class="p">?,</span> <span class="n">withError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">NSError</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
            <span class="kt">NSLog</span><span class="p">(</span><span class="s">"ERROR: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">flicButton</span><span class="p">(</span><span class="nv">button</span><span class="p">:</span> <span class="kt">SCLFlicButton</span><span class="p">,</span> <span class="n">didReceiveButtonDown</span> <span class="nv">queued</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="nv">age</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">toggle</span><span class="p">()</span>
    <span class="p">}</span>
    
    
    <span class="c1">// MARK: Websocket Delegate</span>
    
    <span class="kd">func</span> <span class="nf">websocketDidConnect</span><span class="p">(</span><span class="nv">socket</span><span class="p">:</span> <span class="kt">WebSocket</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">defaults</span> <span class="o">=</span> <span class="kt">NSUserDefaults</span><span class="o">.</span><span class="nf">standardUserDefaults</span><span class="p">()</span>
        <span class="k">let</span> <span class="nv">last</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="nf">stringForKey</span><span class="p">(</span><span class="s">"last_status"</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">name</span> <span class="o">=</span> <span class="n">last</span> <span class="o">==</span> <span class="s">"ws_morning"</span> <span class="p">?</span> <span class="s">"ws_evening"</span> <span class="p">:</span> <span class="s">"ws_morning"</span>
        <span class="k">let</span> <span class="nv">params</span> <span class="o">=</span> <span class="p">[</span><span class="s">"topic"</span><span class="p">:</span> <span class="s">"setValue"</span><span class="p">,</span> <span class="s">"payload"</span><span class="p">:</span> <span class="p">[</span><span class="s">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s">"characteristic"</span><span class="p">:</span> <span class="s">"On"</span><span class="p">,</span> <span class="s">"value"</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">(</span><span class="nv">bool</span><span class="p">:</span> <span class="kc">true</span><span class="p">)]]</span>
        <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">NSJSONSerialization</span><span class="o">.</span><span class="nf">dataWithJSONObject</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="o">.</span><span class="kt">PrettyPrinted</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">string</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">NSUTF8StringEncoding</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">socket</span><span class="o">.</span><span class="nf">writeString</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="n">socket</span><span class="o">.</span><span class="nf">disconnect</span><span class="p">()</span>
            <span class="n">defaults</span><span class="o">.</span><span class="nf">setObject</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="s">"last_status"</span><span class="p">)</span>
            <span class="n">defaults</span><span class="o">.</span><span class="nf">synchronize</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">websocketDidDisconnect</span><span class="p">(</span><span class="nv">socket</span><span class="p">:</span> <span class="kt">WebSocket</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">NSError</span><span class="p">?)</span> <span class="p">{</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">websocketDidReceiveData</span><span class="p">(</span><span class="nv">socket</span><span class="p">:</span> <span class="kt">WebSocket</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">NSData</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">websocketDidReceiveMessage</span><span class="p">(</span><span class="nv">socket</span><span class="p">:</span> <span class="kt">WebSocket</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    
<span class="p">}</span></code></pre></figure>

<p><strong>Note: this is just a personal project that I built as quickly as possible. By nature, it is a fairly dirty hack. You shouldn’t write professional apps like this.</strong></p>

<p>With this code in place, I can now press my Flic button (stuck to the underside of my bedside table) and it will toggle between my <em>Good Morning</em> and <em>Good Night</em> scenes. This is the full process of what is going on:</p>

<ul>
  <li>Press the Flic button</li>
  <li>Wakes up the iOS app (if terminated or backgrounded) and hits the <code class="language-plaintext highlighter-rouge">toggle</code> function</li>
  <li>App sends a websocket command to the Homebridge-websocket server</li>
  <li>Server turns on a fake switch</li>
  <li>HomeKit notices that the fake switch has been turned on so fires trigger to run appropriate scene</li>
  <li>Scene activates or deactivates various accessories and then switches the fake switch back off ensuring it is ready for next button press</li>
</ul>

<p>This is a long way away from the process I’d envisioned (press button, wake up app, toggle scene with HomeKit API) but it has been a fun challenge finding a way to get it work. I now have a physical button that controls multiple aspects of my home with a single press - it’s pretty cool!</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:stuff" role="doc-endnote">
      <p>Ugh what a horrible expression. I renamed it the <em>Internet of Stuff</em> on <a href="https://bendodson.com/weblog/2016/01/27/divide-7-mind-missiles-internet-of-stuff/">episode 7 of The Divide</a>. <a href="#fnref:stuff" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:phrasing" role="doc-endnote">
      <p><a href="https://bendodson.s3.amazonaws.com/phrasing.png"><em>Phrasing</em></a> <a href="#fnref:phrasing" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:biy" role="doc-endnote">
      <p>“Why not just build your own with a Raspberry Pi or similar?”. Because I can’t be bothered; the cost of my time to do that is more than the cost of buying an incredibly well put together button that already does exactly what I want. <a href="#fnref:biy" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:homekitforeground" role="doc-endnote">
      <p>Probably for a very good reason, you likely don’t want an app reading information about or controlling your HomeKit devices when you aren’t literally using the app. It’s a bit of a pain though for a simple app like this. I did manage to find a <code class="language-plaintext highlighter-rouge">com.apple.developer.homekit.background-mode</code> entitlement but there is no way to generate a provisioning profile that uses it. Maybe Apple will add this in a future version of iOS but I wouldn’t count on it. <a href="#fnref:homekitforeground" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:rebuild" role="doc-endnote">
      <p>Technically, as all of my devices have their own APIs I could have just built my app to directly talk to Hue, Canary, iTunes, etc and rebuild my scenes that way. That idea didn’t sit well with me though as it’d be a lot more work and effectively duplicating what I already have. Similarly, I could have just used the native IFTTT support with the Flic to turn on or off some of my devices but that would add more latency and I don’t want to trust my connected home to something that has to be connected online; the beauty of HomeKit is that it works locally. <a href="#fnref:rebuild" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/05/17/fetching-rss-feeds-for-steam-game-updates/">Fetching RSS Feeds for Steam game updates</a></h1>
			
			<time datetime="2016-05-17" pubdate=""><a href="/weblog/2016/05/17/fetching-rss-feeds-for-steam-game-updates/">May 17, 2016</a></time>
    	</header>
    	<div>
			<p>I’m currently in the process of switching from my Xbox One to a gaming PC<sup id="fnref:gamingpc" role="doc-noteref"><a href="#fn:gamingpc" class="footnote" rel="footnote">1</a></sup> and have been spending a lot of time curating my Steam collection on my Mac. One thing I’ve noticed recently is that I often see games being updated but then have to go to their individual pages in order to view the release notes of what has changed (and that is if I even notice a game has been updated). What I really want is a single page that shows me all the patch notes in date order and sends me a notification when something updates.</p>

<p>A quick search found <a href="http://www.getoffmalawn.com/steamnews">SteamNews</a>, a website that aims to turn Steam Community pages into RSS feeds. However, a lot of games are missing and it doesn’t solve the problem of fetching the feeds for my account; I’d still need to go through and add them manually. I also don’t like relying on 3rd party services which I can’t install on my own server.</p>

<p>After a bit of exploring on the Steam pages, I found that most games have an RSS feed of their news page; this, combined with my publicly available profile page listing my owned games, has led me to write a basic PHP script to loop through my games, find the matching RSS feed, and then add it to my Feedbin account:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nb">define</span><span class="p">(</span><span class="s1">'FEEDBIN_USERNAME'</span><span class="p">,</span> <span class="s1">'your username here'</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'FEEDBIN_PASSWORD'</span><span class="p">,</span> <span class="s1">'your password here'</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'STEAM_ID'</span><span class="p">,</span> <span class="s1">'your steam id here i.e. bendodson'</span><span class="p">);</span>

<span class="k">require</span> <span class="s1">'vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Goutte\Client</span><span class="p">;</span>

<span class="nv">$html</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'http://steamcommunity.com/id/'</span><span class="mf">.</span><span class="no">STEAM_ID</span><span class="mf">.</span><span class="s1">'/games/?tab=all'</span><span class="p">);</span>

<span class="nv">$match</span> <span class="o">=</span> <span class="s2">"rgGames = "</span><span class="p">;</span>
<span class="nv">$start</span> <span class="o">=</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$html</span><span class="p">,</span> <span class="nv">$match</span><span class="p">)</span> <span class="o">+</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$match</span><span class="p">);</span>
<span class="nv">$json</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nb">strtok</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$html</span><span class="p">,</span> <span class="nv">$start</span><span class="p">),</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="nv">$array</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">);</span>

<span class="nv">$games</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'games.txt'</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$games</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$games</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$array</span> <span class="k">as</span> <span class="nv">$game</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$unsubscribed</span> <span class="o">=</span> <span class="nv">$game</span><span class="o">-&gt;</span><span class="n">appid</span><span class="mf">.</span><span class="s1">'-0'</span><span class="p">;</span>
	<span class="nv">$subscribed</span> <span class="o">=</span> <span class="nv">$game</span><span class="o">-&gt;</span><span class="n">appid</span><span class="mf">.</span><span class="s1">'-1'</span><span class="p">;</span>
	<span class="nv">$failed</span> <span class="o">=</span> <span class="nv">$game</span><span class="o">-&gt;</span><span class="n">appid</span><span class="mf">.</span><span class="s1">'-x'</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$unsubscribed</span><span class="p">,</span> <span class="nv">$games</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$subscribed</span><span class="p">,</span> <span class="nv">$games</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$failed</span><span class="p">,</span> <span class="nv">$games</span><span class="p">))</span> <span class="p">{</span>
		<span class="nv">$games</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$unsubscribed</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">'games.txt'</span><span class="p">,</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$games</span><span class="p">));</span>

<span class="nv">$games</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'games.txt'</span><span class="p">));</span>
<span class="nv">$index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$games</span> <span class="k">as</span> <span class="nv">$game</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">list</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$subscribed</span><span class="p">)</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"-"</span><span class="p">,</span> <span class="nv">$game</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$subscribed</span> <span class="o">==</span> <span class="s1">'0'</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">subscribeWithSteamIDAtIndex</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$index</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nv">$index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="s1">'Done'</span><span class="p">;</span>


<span class="k">function</span> <span class="n">subscribeWithSteamIDAtIndex</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$url</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span> <span class="p">{</span>

	<span class="nv">$key</span> <span class="o">=</span> <span class="nv">$url</span> <span class="o">==</span> <span class="s1">''</span> <span class="o">?</span> <span class="nv">$id</span> <span class="o">:</span> <span class="nv">$url</span><span class="p">;</span>
	<span class="nv">$feedURL</span> <span class="o">=</span> <span class="nv">$url</span> <span class="o">==</span> <span class="s1">''</span> <span class="o">?</span> <span class="s1">'http://steamcommunity.com/games/'</span><span class="mf">.</span><span class="nv">$id</span><span class="mf">.</span><span class="s1">'/rss/'</span> <span class="o">:</span> <span class="nv">$url</span><span class="p">;</span>
	<span class="k">echo</span> <span class="s1">'Subscribing to '</span><span class="mf">.</span><span class="nv">$feedURL</span><span class="mf">.</span><span class="s1">'&lt;br&gt;'</span><span class="p">;</span>
	<span class="nv">$post</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">([</span><span class="s2">"feed_url"</span> <span class="o">=&gt;</span> <span class="nv">$feedURL</span><span class="p">]);</span>

	<span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_HTTPHEADER</span><span class="p">,</span> <span class="p">[</span><span class="s1">'Content-Type: application/json; charset=utf-8'</span><span class="p">]);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_URL</span><span class="p">,</span> <span class="s1">'https://api.feedbin.com/v2/subscriptions.json'</span><span class="p">);</span>    	
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_TIMEOUT</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span> 
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_USERPWD</span><span class="p">,</span> <span class="no">FEEDBIN_USERNAME</span> <span class="mf">.</span> <span class="s2">":"</span> <span class="mf">.</span> <span class="no">FEEDBIN_PASSWORD</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_POST</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_POSTFIELDS</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span>
	<span class="nv">$output</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
	<span class="nv">$statusCode</span> <span class="o">=</span> <span class="nb">curl_getinfo</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLINFO_HTTP_CODE</span><span class="p">);</span>
	<span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$statusCode</span> <span class="o">==</span> <span class="mi">404</span> <span class="o">&amp;&amp;</span> <span class="nv">$url</span> <span class="o">==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>

		<span class="nv">$success</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

		<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Client</span><span class="p">();</span>
		<span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">request</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'http://steamcommunity.com/app/'</span><span class="mf">.</span><span class="nv">$id</span><span class="mf">.</span><span class="s1">'/allnews/'</span><span class="p">);</span>
		<span class="nv">$elements</span> <span class="o">=</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="nf">filter</span><span class="p">(</span><span class="s1">'#apphub_InitialContent .Announcement_Card:first-child'</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$elements</span><span class="o">-&gt;</span><span class="nb">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$url</span> <span class="o">=</span> <span class="nv">$elements</span><span class="o">-&gt;</span><span class="nf">attr</span><span class="p">(</span><span class="s1">'data-modal-content-url'</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Client</span><span class="p">();</span>
				<span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">request</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="nv">$url</span><span class="p">);</span>
				<span class="nv">$url</span> <span class="o">=</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="nf">selectLink</span><span class="p">(</span><span class="s1">'Subscribe to RSS Feed'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">attr</span><span class="p">(</span><span class="s1">'href'</span><span class="p">);;</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$success</span> <span class="o">=</span> <span class="nf">subscribeWithSteamIDAtIndex</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$url</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$success</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$games</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'games.txt'</span><span class="p">));</span>
			<span class="nv">$games</span><span class="p">[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$id</span><span class="mf">.</span><span class="s1">'-x'</span><span class="p">;</span>
			<span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">'games.txt'</span><span class="p">,</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$games</span><span class="p">));</span>			
			<span class="k">echo</span> <span class="s1">'Failed&lt;br&gt;&lt;br&gt;'</span><span class="p">;</span>
		<span class="p">}</span>


	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$statusCode</span> <span class="o">==</span> <span class="mi">201</span><span class="p">)</span> <span class="p">{</span>

		<span class="nv">$subscription</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$output</span><span class="p">);</span>
		<span class="nv">$post</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">([</span><span class="s2">"feed_id"</span> <span class="o">=&gt;</span> <span class="nv">$subscription</span><span class="o">-&gt;</span><span class="n">feed_id</span><span class="p">,</span> <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"Steam Games"</span><span class="p">]);</span>
		
		<span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
		<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_HTTPHEADER</span><span class="p">,</span> <span class="p">[</span><span class="s1">'Content-Type: application/json; charset=utf-8'</span><span class="p">]);</span>
		<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_URL</span><span class="p">,</span> <span class="s1">'https://api.feedbin.com/v2/taggings.json'</span><span class="p">);</span>    	
		<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
		<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_TIMEOUT</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span> 
		<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_USERPWD</span><span class="p">,</span> <span class="no">FEEDBIN_USERNAME</span> <span class="mf">.</span> <span class="s2">":"</span> <span class="mf">.</span> <span class="no">FEEDBIN_PASSWORD</span><span class="p">);</span>
		<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_POST</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_POSTFIELDS</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span>
		<span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
		<span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$statusCode</span> <span class="o">==</span> <span class="mi">201</span> <span class="o">||</span> <span class="nv">$statusCode</span> <span class="o">==</span> <span class="mi">302</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$games</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'games.txt'</span><span class="p">));</span>
		<span class="nv">$games</span><span class="p">[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$id</span><span class="mf">.</span><span class="s1">'-1'</span><span class="p">;</span>
		<span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">'games.txt'</span><span class="p">,</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$games</span><span class="p">));</span>
		<span class="k">echo</span> <span class="s1">'Subscribed!&lt;br&gt;&lt;br&gt;'</span><span class="p">;</span>
		<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>There is a fair amount going on in this script<sup id="fnref:goodpractice" role="doc-noteref"><a href="#fn:goodpractice" class="footnote" rel="footnote">2</a></sup> but the basic overview is:</p>

<ol>
  <li>
    <p>Fetch a list of owned games from the public profile of the entered Steam ID. Most of the Steam pages are built with Javascript but this page fortunately has the entire library as JSON within the page. After a simple bit of extraction, I have a full list of every game owned.</p>
  </li>
  <li>
    <p>Update a local text file<sup id="fnref:database" role="doc-noteref"><a href="#fn:database" class="footnote" rel="footnote">3</a></sup> – games.txt – with a list of games. I store each game as an ID followed by a hyphen and a flag to denote whether the game is unsubscribed, subscribed, or failed. For example, if I’m subscribed to the <a href="http://store.steampowered.com/app/359320/">Elite: Dangerous game</a>, the text file will contain 359320-1 as the game ID is 359320.</p>
  </li>
  <li>
    <p>Just to be a pain, Steam doesn’t have a standard format for it’s RSS feeds. Whilst most of them contain the game ID, some of them don’t. The first step is to go with the usual URL and then if that fails we’ll use <a href="https://github.com/FriendsOfPHP/Goutte">Goutte</a> to manually scrape the news page and then the first news item in order to grab the correct RSS feed. For example, the game ID of <a href="http://store.steampowered.com/app/240/">Counter-Strike: Source</a> is 240 so the script will first try <code class="language-plaintext highlighter-rouge">http://steamcommunity.com/games/240/rss/</code> but when that fails it’ll crawl through some pages to discover the correct URL is <code class="language-plaintext highlighter-rouge">http://steamcommunity.com/games/CSS/rss/</code> - there seems to be no logic as to which games have a shorthand name and which don’t and there isn’t an easy way to work out what the name would be.</p>
  </li>
  <li>
    <p>Once I have a valid RSS feed, it is subscribed to via the <a href="https://github.com/feedbin/feedbin-api">Feedbin API</a>. As an added bonus, I also tag the subscription “Steam Games” so they show up all together in my RSS reader of choice, <a href="http://reederapp.com/mac/">Reeder</a>: <img src="https://bendodson.s3.amazonaws.com/weblog/2016/steam-rss-feeds.jpg" width="800" height="559" alt="Steam RSS feeds in Reeder via Feedbin" /></p>
  </li>
  <li>
    <p>Sometimes, the process might fail as in the case of <a href="http://steamcommunity.com/app/4540/allnews/">Titan Quest</a> which has no updates and thus no RSS feed. If that happens, the game is marked in the text file so that it can be safely ignored. In my own version of the script, I added Slack integration so I get a notification when a game fails so I check to see if it is a simple case of no feed or if my script has broken: <img src="https://bendodson.s3.amazonaws.com/weblog/2016/steam-rss-slack.jpg" width="700" height="200" alt="Steam RSS feed failure in Slack" /></p>
  </li>
</ol>

<p>I have the script set up on a cron so if I purchase a new game the RSS feed for it should appear in Feedbin within the hour<sup id="fnref:twentyfour" role="doc-noteref"><a href="#fn:twentyfour" class="footnote" rel="footnote">4</a></sup>.</p>

<p>One idea I dabbled with was fetching the feeds myself and building a single large RSS feed that I could subscribe to. There are a few issues there though:</p>

<ul>
  <li>
    <p>It would require me to constantly fetch each feed which could be huge if I own hundreds of games. I already pay for my RSS subscription service (Feedbin) so why add more complexity when they can do that for me?</p>
  </li>
  <li>
    <p>I’d be sacrificing some customisation. If I’m not interested in a specific game, I can simply remove the feed from Feedbin. My script doesn’t check subscriptions so it won’t try and re-add it.</p>
  </li>
  <li>
    <p>There is no benefit to one large RSS feed. If I was doing this as a commercial service (i.e. a hosted page where you enter your username and I give you a single feed) then it may make sense but I’m not interested in doing that<sup id="fnref:youngmansgame" role="doc-noteref"><a href="#fn:youngmansgame" class="footnote" rel="footnote">5</a></sup>.</p>
  </li>
</ul>

<p>I’ve put all of the <a href="https://github.com/bendodson/Steam-RSS">code on GitHub</a> in case it is of interest to anyone.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:gamingpc" role="doc-endnote">
      <p>The main reasons being far higher resolution and quality, cheaper games, and virtual reality. I’ll miss Xbox achievements but the boost in visual quality more than makes up for that (and with controller support and a SteamLink, I can still play most games on my sofa with an Xbox One Elite Controller). <a href="#fnref:gamingpc" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:goodpractice" role="doc-endnote">
      <p>Please do not look at this and assume this is any way good practice. This is a very fast and loose piece of coding in order to achieve a specific goal as quickly as possible; most of it will break if Steam update their HTML pages (very likely). <a href="#fnref:goodpractice" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:database" role="doc-endnote">
      <p>“Why not use a database” - I couldn’t be bothered to set one up. A basic text file does the job. <a href="#fnref:database" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:twentyfour" role="doc-endnote">
      <p>“Within the hour” - can you tell I’ve been rewatching 24 lately? <a href="#fnref:twentyfour" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:youngmansgame" role="doc-endnote">
      <p>When I was younger, that is exactly what I would have done but as I’ve grown older I’ve realised that hosting stuff for free is a massive headache. Much better to stick the code on GitHub and let people use it on their own if they want. <a href="#fnref:youngmansgame" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/05/12/airplay-alarm-clock-with-itunes-12/">AirPlay Alarm Clock with iTunes 12</a></h1>
			
			<time datetime="2016-05-12" pubdate=""><a href="/weblog/2016/05/12/airplay-alarm-clock-with-itunes-12/">May 12, 2016</a></time>
    	</header>
    	<div>
			<p>A few years ago, <a href="https://bendodson.com/weblog/2011/01/10/the-airplay-alarm-clock-turning-an-apple-tv-or-airport-express-into-an-alarm-clock-with-applescript/">I wrote a convoluted AppleScript</a> that allowed me to use my Apple TV as an alarm clock. It worked by waking up iTunes, selecting a playlist, shuffling it, and then playing it via AirPlay. Unfortunately, it stopped working when iTunes 11 was released due to a number of changes to AppleScript support; there were also changes to OS X which prevented AppleScripts from launching via Calendar alerts.</p>

<p>Fast forward to today and I found myself needing this script again for a new project<sup id="fnref:homekitproject" role="doc-noteref"><a href="#fn:homekitproject" class="footnote" rel="footnote">1</a></sup>. After a bit of hacking around, I’ve managed to get the script fully updated for iTunes 12:</p>

<figure class="highlight"><pre><code class="language-applescript" data-lang="applescript"><span class="k">set</span><span class="w"> </span><span class="nv">AirplayDeviceName</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="s2">"Kitchen"</span><span class="w">
</span><span class="k">set</span><span class="w"> </span><span class="nv">PlaylistName</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="s2">"Morning"</span><span class="w">
</span><span class="k">set</span><span class="w"> </span><span class="nv">AirplayVolume</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">100</span><span class="w">

</span><span class="nb">activate</span><span class="w"> </span><span class="nb">application</span><span class="w"> </span><span class="s2">"iTunes"</span><span class="w">

</span><span class="k">tell</span><span class="w"> </span><span class="nb">application</span><span class="w"> </span><span class="s2">"System Events"</span><span class="w">
	</span><span class="k">tell</span><span class="w"> </span><span class="nb">application</span><span class="w"> </span><span class="s2">"iTunes"</span><span class="w">
		</span><span class="k">set</span><span class="w"> </span><span class="na">visible</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">front</span><span class="w"> </span><span class="nb">browser</span><span class="w"> </span><span class="na">window</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nb">true</span><span class="w">
		</span><span class="k">set</span><span class="w"> </span><span class="nb">the</span><span class="w"> </span><span class="na">view</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">the</span><span class="w"> </span><span class="nb">front</span><span class="w"> </span><span class="nb">browser</span><span class="w"> </span><span class="na">window</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nv">playlist</span><span class="w"> </span><span class="nv">PlaylistName</span><span class="w">
	</span><span class="k">end</span><span class="w"> </span><span class="k">tell</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">tell</span><span class="w">

</span><span class="k">tell</span><span class="w"> </span><span class="nb">application</span><span class="w"> </span><span class="s2">"System Events"</span><span class="w">
	</span><span class="k">tell</span><span class="w"> </span><span class="nv">process</span><span class="w"> </span><span class="s2">"iTunes"</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">exists</span><span class="w"> </span><span class="k">then</span><span class="w">
		</span><span class="nv">click</span><span class="w"> </span><span class="na">menu</span><span class="w"> </span><span class="nb">item</span><span class="w"> </span><span class="s2">"Songs"</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="na">menu</span><span class="w"> </span><span class="s2">"Shuffle"</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="na">menu</span><span class="w"> </span><span class="nb">item</span><span class="w"> </span><span class="s2">"Shuffle"</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="na">menu</span><span class="w"> </span><span class="s2">"Controls"</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="na">menu</span><span class="w"> </span><span class="nv">bar</span><span class="w"> </span><span class="mi">1</span><span class="w">
		</span><span class="nv">click</span><span class="w"> </span><span class="na">menu</span><span class="w"> </span><span class="nb">item</span><span class="w"> </span><span class="s2">"On"</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="na">menu</span><span class="w"> </span><span class="s2">"Shuffle"</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="na">menu</span><span class="w"> </span><span class="nb">item</span><span class="w"> </span><span class="s2">"Shuffle"</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="na">menu</span><span class="w"> </span><span class="s2">"Controls"</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="na">menu</span><span class="w"> </span><span class="nv">bar</span><span class="w"> </span><span class="mi">1</span><span class="w">
	</span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">tell</span><span class="w">

</span><span class="k">tell</span><span class="w"> </span><span class="nb">application</span><span class="w"> </span><span class="s2">"iTunes"</span><span class="w">
	</span><span class="k">set</span><span class="w"> </span><span class="nv">AirplayNames</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="p">(</span><span class="k">get</span><span class="w"> </span><span class="na">name</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nv">AirPlay</span><span class="w"> </span><span class="nv">devices</span><span class="p">)</span><span class="w">
	</span><span class="k">set</span><span class="w"> </span><span class="nv">AirplayDevices</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="p">(</span><span class="k">get</span><span class="w"> </span><span class="nv">AirPlay</span><span class="w"> </span><span class="nv">devices</span><span class="p">)</span><span class="w">
	</span><span class="k">set</span><span class="w"> </span><span class="nv">AirplayToPlay</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="p">{}</span><span class="w">
	</span><span class="k">repeat</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nv">length</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nv">AirplayNames</span><span class="w">
		</span><span class="k">if</span><span class="w"> </span><span class="nb">item</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nv">AirplayNames</span><span class="w"> </span><span class="k">as </span><span class="nc">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">AirplayDeviceName</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nv">AirplayToPlay</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nb">item</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nv">AirplayDevices</span><span class="w">
	</span><span class="k">end</span><span class="w"> </span><span class="k">repeat</span><span class="w">
	</span><span class="k">set</span><span class="w"> </span><span class="nv">current</span><span class="w"> </span><span class="nv">AirPlay</span><span class="w"> </span><span class="nv">devices</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nv">AirplayToPlay</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">tell</span><span class="w">

</span><span class="k">tell</span><span class="w"> </span><span class="nb">application</span><span class="w"> </span><span class="s2">"iTunes"</span><span class="w">
	</span><span class="nb">play</span><span class="w"> </span><span class="nv">playlist</span><span class="w"> </span><span class="nv">PlaylistName</span><span class="w">
	</span><span class="k">set</span><span class="w"> </span><span class="nb">the</span><span class="w"> </span><span class="na">sound</span><span class="w"> </span><span class="na">volume</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nv">AirplayVolume</span><span class="w">
</span><span class="k">end</span><span class="w"> </span><span class="k">tell</span></code></pre></figure>

<p>The script is significantly smaller thanks to some new AirPlay APIs within iTunes and I’ve updated it to allow for simple changing of volume. It should work in all versions of iTunes 11 and iTunes 12.</p>

<p>In order to get this working as an alarm, we have to jump through a number of hoops on OS X El Capitan. Firstly, we need to save our AppleScript as an application (after you’ve made any adjustments to your Airplay device name, playlist name, and the volume you want). You can do this by opening it within Script Editor and then choosing <em>File &gt; Export</em>.</p>

<p><img src="https://bendodson.s3.amazonaws.com/weblog/2016/airplay-alarm-export.jpg" width="800" height="800" alt="Export AppleScript as Application" /></p>

<p><strong>If you haven’t disabled the GateKeeper restrictions on your Mac, you will need to either Code Sign this app or grant an exception within the Security &amp; Privacy settings after you have first tried to open it.</strong></p>

<p>With the alarm exported, we now need to open up Automator and create a new <em>Calendar Alarm</em>. Find the <em>Launch Application</em> action and set that up to point to your newly exported alarm app. Finally, save this and you’ll find a new entry has appeared in your calendar; it will launch immediately thus starting off the iTunes alarm process. Simply copy and paste this alarm entry (or make it recurring) in order to set it to whatever times you want.</p>

<p>I’m going to continue playing around with different ways to launch the alarm but for now this works in much the same way as my old script did.</p>

<p>The full code (and previous version) is <a href="https://github.com/bendodson/Apple-TV-Alarm-Clock">available on GitHub</a>.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:homekitproject" role="doc-endnote">
      <p>I’m experimenting with some HomeKit APIs with the aim being that my “Good morning” scene can be activated by a physical button and will not only turn on my lights and disable my security camera but also start playing my morning playlist in the kitchen. This is what I do for fun. <a href="#fnref:homekitproject" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/05/04/divide-12-reboots/">The Divide #12 - Reboots</a></h1>
			
			<time datetime="2016-05-04" pubdate=""><a href="/weblog/2016/05/04/divide-12-reboots/">May 04, 2016</a></time>
    	</header>
    	<div>
			<p>The 12th episode of <a href="http://thedivide.co.uk/">The Divide podcast</a> is now available in which we have a lengthy discussion on reboots, particularly in movie franchises like Spiderman, Batman, and that film by that director we’re not allowed to mention in front of Chris. In addition, we address some board game follow-up, tell you how to test a HTC Vive in the UK, and get all excited at the prospect of a new Red Dead Redemption game!</p>

<p>You can get The Divide from these fine outlets:</p>

<ul>
  <li><a href="https://itunes.apple.com/gb/podcast/the-divide/id1063410638">iTunes</a></li>
  <li><a href="https://overcast.fm/itunes1063410638/the-divide">Overcast</a></li>
  <li><a href="http://thedivide.co.uk/shows/itunes.xml">RSS</a> (for other podcast readers)</li>
  <li><a href="http://thedivide.co.uk/">The Divide website</a></li>
</ul>

<p>Don’t forget to leave a review on iTunes and follow us on Twitter via <a href="http://twitter.com/PodcastDivide">@PodcastDivide</a>.</p>

		</div>
	</article>
    
	
</section>


<section id="pagination">
     
    	<a href="/weblog/page/7/" title="Previous Page" class="pagination-previous">&laquo; Older Entries</a>
     
	
    
      
      	<a href="/weblog/page/5/" title="Next Page" class="pagination-next">Newer Entries &raquo; </a>
      
    
</section>

		
		<footer>
			<p>I perform all freelance work through my company <strong>Dodo Apps Ltd</strong> (07856552) registered at The Bristol Office, 2nd Floor, 5 High Street, Westbury on Trym, Bristol, England, BS9 3BY</p>
		</footer>

	</div>


</body>
</html>