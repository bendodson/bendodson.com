<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	
	


	<link href='https://fonts.googleapis.com/css?family=PT+Sans+Caption:400,700' rel='stylesheet' type='text/css'>
	<link rel="alternate" type="application/rss+xml" title="Ben Dodson, iOS Developer" href="https://bendodson.com/rss.xml" />
	<link rel="stylesheet" href="/styles-2018-07-02.css" />
	<link rel="stylesheet" href="/highlight-2018-02-23.css" />
	<link rel="icon" href="https://bendodson.s3.amazonaws.com/bendodson.com/favicon.ico">
	<link rel="apple-touch-icon" href="https://bendodson.s3.amazonaws.com/bendodson.com/touch-icon-iphone.png">
	<link rel="apple-touch-icon" sizes="76x76" href="https://bendodson.s3.amazonaws.com/bendodson.com/touch-icon-ipad.png">
	<link rel="apple-touch-icon" sizes="120x120" href="https://bendodson.s3.amazonaws.com/bendodson.com/touch-icon-iphone-retina.png">
	<link rel="apple-touch-icon" sizes="152x152" href="https://bendodson.s3.amazonaws.com/bendodson.com/touch-icon-ipad-retina.png">
	<link rel="apple-touch-icon" sizes="180x180" href="https://bendodson.s3.amazonaws.com/bendodson.com/touch-icon-ipad-retina.png">
	<title>Ben Dodson's Blog &mdash; Freelance Swift Developer and WallaBee Founder</title>
</head>
<body>

	<div id="wrapper">

		<header>
			<hgroup>
				<h1><a href="/">Ben Dodson</a></h1>
				<h2>Freelance iOS, Apple Watch, and Apple TV Developer</h2>
			</hgroup>
			<nav>
				<ul>
					<li><a href="/">Home</a></li><li><a href="/weblog/">Blog</a></li><li><a href="/about/">About</a></li><li><a href="/clients/">Portfolio</a></li><li><a href="/apps/">My Apps</a></li><li><a href="/projects/">Projects</a></li><li><a href="/contact/">Contact</a></li>
				</ul>
				<div class="divider"></div>
			</nav>
		</header>

		<section id="posts">

	
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/08/05/divide-15-virtually-reality/">The Divide #15 - Virtually Reality</a></h1>
			
			<time datetime="2016-08-05" pubdate=""><a href="/weblog/2016/08/05/divide-15-virtually-reality/">August 05, 2016</a></time>
    	</header>
    	<div>
			<p>After a short summer break we’re back with <a href="http://thedivide.co.uk/episodes/15">episode 15 of The Divide podcast</a> which is all about virtual reality. John has a fancy new HTC Vive, I’m trying to convince myself I don’t need one, and Chris just wants to be on the bridge with Captain Janeway…</p>

<p>You can get The Divide from these fine outlets:</p>

<ul>
  <li><a href="https://itunes.apple.com/gb/podcast/the-divide/id1063410638">iTunes</a></li>
  <li><a href="https://overcast.fm/itunes1063410638/the-divide">Overcast</a></li>
  <li><a href="http://thedivide.co.uk/shows/itunes.xml">RSS</a> (for other podcast readers)</li>
  <li><a href="http://thedivide.co.uk/">The Divide website</a></li>
</ul>

<p>Don’t forget to leave a review on iTunes and follow us on Twitter via <a href="http://twitter.com/PodcastDivide">@PodcastDivide</a>.</p>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/08/02/media-library-privacy-flaw-fixed-in-ios-10/">Media Library privacy flaw fixed in iOS 10</a></h1>
			
			<time datetime="2016-08-02" pubdate=""><a href="/weblog/2016/08/02/media-library-privacy-flaw-fixed-in-ios-10/">August 02, 2016</a></time>
    	</header>
    	<div>
			<p>As I’ve mentioned <a href="https://bendodson.com/weblog/2016/01/13/your-music-library-is-a-security-and-privacy-risk-on-ios/">many times before</a>, iOS had a pretty terrible privacy flaw in that apps didn’t need any permissions in order to read through your media library. This was an issue as it meant you could be fingerprinted easily and tracked across various apps<sup id="fnref:proof"><a href="#fn:proof" class="footnote">1</a></sup>. Thankfully, this has now been fixed in iOS 10<sup id="fnref:fixed"><a href="#fn:fixed" class="footnote">2</a></sup>.</p>

<p>In this article, I’ll explain how to update your apps to support this new privacy requirement. Before I do that, I’m going to show you what happens if you run an app built against the iOS 9.3 SDK (or earlier) on iOS 10:</p>

<p><img src="https://bendodson.s3.amazonaws.com/weblog/2016/access-apple-music.jpg" width="800" height="450" alt="[app name] would like to access Apple Music" /></p>

<p>You’ll be prompted<sup id="fnref:permissiontext"><a href="#fn:permissiontext" class="footnote">3</a></sup> to allow permissions as soon as any media library code is encountered be that on app startup or in a background process such as that used by <a href="https://dodoapps.io/music-tracker/">Music Tracker</a>. If you decline to give permission then the app will quit to the home screen and you will not be able to use it. This is a big change from previous permission switches whereby apps built against the old SDK would be exempt from new permissions (i.e. if your iOS 7 SDK compiled app ran on iOS 8, it wouldn’t crash because it wasn’t using the new location privacy options). Personally I like this change as it allows you to see clearly which apps were abusing these APIs such as <a href="https://twitter.com/rosyna/status/743427770760364034">Canary</a> and <a href="https://twitter.com/chinanderm/status/743091483595546624">Google Calendar</a>.</p>

<p><strong>Bottom line</strong>: If you are using <code>MPMediaQuery</code> or similar in your app, you’d better update it with the iOS 10 SDK as soon as possible as otherwise you are going to get a lot of crashes if your users don’t allow the permission (or a lot of awkward questions if you shouldn’t be using this API).</p>

<p>How do you update your app to request permission for these APIs? First of all, lets whip up a basic example with Swift 3 that will pull the title of the first track in your music library:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="kr">@IBAction</span> <span class="kd">func</span> <span class="nf">buttonPressed</span><span class="p">(</span><span class="kc">_</span> <span class="n">sender</span><span class="p">:</span> <span class="nb">AnyObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">query</span> <span class="p">=</span> <span class="bp">MPMediaQuery</span><span class="p">.</span><span class="n">songs</span><span class="p">()</span>
    <span class="k">if</span> <span class="kd">let</span> <span class="nv">items</span> <span class="p">=</span> <span class="n">query</span><span class="p">.</span><span class="n">items</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">item</span> <span class="p">=</span> <span class="n">items</span><span class="p">.</span><span class="bp">first</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">&quot;Title: </span><span class="si">\(</span><span class="n">item</span><span class="p">.</span><span class="n">title</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>In keeping with other permissions based APIs such as photos, contacts, and calendars, iOS 10 requires that you add a new key to your Info.plist file to explain why you want to use this permission; for music library access, this key is <code>NSAppleMusicUsageDescription</code>. If you don’t add this key, your app will crash as soon as you try and access an <code>MPMediaQuery</code> with the following message:</p>

<blockquote>
  <p><em>This app has crashed because it attempted to access privacy-sensitive data without a usage description.  The app’s Info.plist must contain an NSAppleMusicUsageDescription key with a string value explaining to the user how the app uses this data.</em></p>
</blockquote>

<p>With the <code>NSAppleMusicUsageDescription</code> key in place, you will now be given a standard permission dialogue when you first try and access the users media library. If the user chooses “Don’t Allow”, then the media query will fail and any subsequent calls will request in the <code>query.items</code> property being nil. If they choose “OK”, then nothing happens (as execution of the code is not suspended and there is no callback). To fix this, we need to use the <code>MPMediaLibrary.authorizationStatus()</code> and <code>requestAuthorization((MPMediaLibraryAuthorizationStatus) -&gt; Void)</code> APIs that were added in iOS 9.3 to do something like this:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="kr">@IBAction</span> <span class="kd">func</span> <span class="nf">buttonPressed</span><span class="p">(</span><span class="kc">_</span> <span class="n">sender</span><span class="p">:</span> <span class="nb">AnyObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="bp">MPMediaLibrary</span><span class="p">.</span><span class="n">requestAuthorization</span> <span class="p">{</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="n">status</span> <span class="p">==</span> <span class="p">.</span><span class="n">authorized</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">runMediaLibraryQuery</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">displayMediaLibraryError</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">runMediaLibraryQuery</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">query</span> <span class="p">=</span> <span class="bp">MPMediaQuery</span><span class="p">.</span><span class="n">songs</span><span class="p">()</span>
    <span class="k">if</span> <span class="kd">let</span> <span class="nv">items</span> <span class="p">=</span> <span class="n">query</span><span class="p">.</span><span class="n">items</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">item</span> <span class="p">=</span> <span class="n">items</span><span class="p">.</span><span class="bp">first</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">&quot;Title: </span><span class="si">\(</span><span class="n">item</span><span class="p">.</span><span class="n">title</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">displayMediaLibraryError</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">error</span><span class="p">:</span> <span class="nb">String</span>
    <span class="k">switch</span> <span class="bp">MPMediaLibrary</span><span class="p">.</span><span class="n">authorizationStatus</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">case</span> <span class="p">.</span><span class="n">restricted</span><span class="p">:</span>
        <span class="n">error</span> <span class="p">=</span> <span class="s">&quot;Media library access restricted by corporate or parental settings&quot;</span>
    <span class="k">case</span> <span class="p">.</span><span class="n">denied</span><span class="p">:</span>
        <span class="n">error</span> <span class="p">=</span> <span class="s">&quot;Media library access denied by user&quot;</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="n">error</span> <span class="p">=</span> <span class="s">&quot;Unknown error&quot;</span>
    <span class="p">}</span>
    
    <span class="kd">let</span> <span class="nv">controller</span> <span class="p">=</span> <span class="bp">UIAlertController</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Error&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span> <span class="n">preferredStyle</span><span class="p">:</span> <span class="p">.</span><span class="n">alert</span><span class="p">)</span>
    <span class="n">controller</span><span class="p">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">UIAlertAction</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="p">.</span><span class="k">default</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">))</span>
    <span class="n">present</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>You first need to request authorization and then run your code only if the status is <code>authorized</code>. If not, then you should display an error specific to whether or not the request was <code>denied</code> or <code>restricted</code> (usually by corporate or parental controls).</p>

<p>I’ve put an <a href="https://github.com/bendodson/media-library-access-in-ios-10">example project on GitHub</a> which uses the code above by way of demonstration.</p>

<p>I’m extremely grateful to everyone that has helped share my posts about this issue and to the engineers at Apple for fixing this privacy flaw. I’ll update this post should anything change between now and the expected public release of iOS 10 in September.</p>

<div class="footnotes">
  <ol>
    <li id="fn:proof">
      <p>Whilst I had no concrete proof of this at the time of writing those articles, it <a href="https://twitter.com/rosyna/status/743398363496751104">looks like I was right that this was a widespread problem</a>. <a href="#fnref:proof" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:fixed">
      <p>I don’t want to take all the credit for this but I honestly don’t think this would have been fixed if I hadn’t raised the issue repeatedly over the last 7 months. <a href="#fnref:fixed" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:permissiontext">
      <p>In earlier builds of iOS 10 you’d be asked “<em>[App Name] Would Like to Access Apple Music</em>” (as shown in screenshots above) but as of iOS 10 beta 4 this has been changed to the more appropriate “<em>[App Name] Would Like to Access Apple Music and Your Media Library</em>”. <a href="#fnref:permissiontext" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/07/20/talking-shop-with-ben-dodson/">Talking Shop with Ben Dodson</a></h1>
			
			<time datetime="2016-07-20" pubdate=""><a href="/weblog/2016/07/20/talking-shop-with-ben-dodson/">July 20, 2016</a></time>
    	</header>
    	<div>
			<p>I was recently interviewed by the lovely folks at <a href="http://cushionapp.com/">Cushion</a><sup id="fnref:cushion"><a href="#fn:cushion" class="footnote">1</a></sup> as part of their <a href="http://cushionapp.com/talking-shop/">Talking Shop series</a> about my life as a freelancer. You can <a href="http://cushionapp.com/talking-shop/ben-dodson/">read the full interview on their website</a> but I’ve also put their questions and my answers below:</p>

<h3 id="how-did-you-get-your-start">How did you get your start?</h3>

<blockquote>
  <p>I started off strictly as a web developer, moving from agency to agency, not really enjoying what I was doing. At the same time, Apple had just released the iPhone and, shortly afterwards, the App Store. I thought iOS development looked fun, so I quit my job and started teaching myself how to do it.</p>
</blockquote>

<h3 id="where-did-your-first-clients-come-from">Where did your first clients come from?</h3>

<blockquote>
  <p>I had been freelancing as a web developer on the side for a number of years, so I had a few clients through that. Coincidentally, when I decided to freelance full-time, a friend from Twitter reached out and asked if I would be interested in appearing on The Gadget Show. For the segment the show wanted a freelance developer and a small company to build two separate apps, then see which was more popular. At the time, I had never built an app, so naturally, I said yes. It forced me to learn the ropes pretty quickly! I cobbled this app together and it ended up doing really well, scoring a feature from the App Store. From there, clients just kept coming.</p>
</blockquote>

<h3 id="what-type-of-projects-do-you-work-on-now">What type of projects do you work on now?</h3>

<blockquote>
  <p>Now there’s also the iPad, Apple Watch, Apple TV, so I work on a variety of projects — everything from little apps to find the best steak restaurant nearby to bigger ones for clients like L’Oreal and Glenfiddich.</p>
</blockquote>

<h3 id="what-does-your-day-to-day-look-like">What does your day-to-day look like?</h3>

<blockquote>
  <p>At this point, I try to exclusively work from home. In the beginning, clients would insist on coming to their office. Those days would always be spent in meetings, talking about nothing, and not getting much done. Nowadays, I push for a video call in lieu of all that. I have clients I’ve never even spoken to, that I work with via email or Slack. They’re the best.</p>
</blockquote>

<h3 id="what-has-been-the-greatest-challenge-of-kind-of-being-a-freelancer">What has been the greatest challenge of kind of being a freelancer?</h3>

<blockquote>
  <p>For me, it’s been time management. It’s so easy to procrastinate. Then you hit a deadline and realize that you’ve done nothing, you have to tell the client, but you don’t want to tell the client, so things get worse quickly. The biggest challenge for me was getting to a point where I can switch my work mode on and off.</p>
</blockquote>

<h3 id="whats-next-for-you">What’s next for you?</h3>

<blockquote>
  <p>A few years ago, I had my own app, an iPhone game called WallaBee. For about three and a half years, I focused on that and was extremely adamant about not hiring anyone else. In retrospect, some help might have made sense, but I was worried about being able to pay someone reliably month to month. It was a lot of fun, but eventually, I burned out and sold it.</p>
</blockquote>

<h3 id="ultimately-id-like-to-do-something-like-that-again-but-at-the-moment-i-enjoy-freelancing">Ultimately, I’d like to do something like that again, but at the moment, I enjoy freelancing.</h3>

<blockquote>
  <p>It’s a constant battle between doing things that you want to do, but not earning any money, and doing the things that are less enjoyable, but make money.</p>
</blockquote>

<h3 id="im-sure-that-statement-resonates-with-a-lot-of-freelancers">I’m sure that statement resonates with a lot of freelancers.</h3>

<blockquote>
  <p>When I was young and single, it was easy to spend twenty hours a day working on my pet project for no pay. The money earned mattered less because at the end of the day, it was just me. But when you have a family with mouths to feed and bills to pay, you find yourself taking less of those risks and opting for projects that provide a bit more security.</p>
</blockquote>

<h3 id="what-advice-would-you-give-to-someone-just-starting-out">What advice would you give to someone just starting out?</h3>

<blockquote>
  <p>Keep it simple. I spent a long time researching and reading up on various how-to-get-things-done philosophies, buying every to-do list manager there was. Now I just have a basic list, make my own invoices, and track everything else in Cushion. If you spend a fortune on loads of tools and to-do lists and all that, you end up spending more time tweaking your setup for productivity than actually being productive.</p>
</blockquote>

<div class="footnotes">
  <ol>
    <li id="fn:cushion">
      <p>If you’re a freelancer, you should definitely check out <a href="http://cushionapp.com/">Cushion</a>. It’s an awesome online tool for keeping track of your clients and scheduling - I’ve been using it for nearly a year and it has helped me avoid overbooking myself. I’m super excited for their invoicing tools which they are launching soon. <a href="#fnref:cushion" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/07/10/passwordless-user-accounts-within-ios-apps/">Creating passwordless user accounts within iOS apps</a></h1>
			
			<time datetime="2016-07-10" pubdate=""><a href="/weblog/2016/07/10/passwordless-user-accounts-within-ios-apps/">July 10, 2016</a></time>
    	</header>
    	<div>
			<p>I’m currently in the process of writing an app which will store some information for each user on a server; the stored data should be available to the user on all of their devices. Usually there are two ways of dealing with this:</p>

<ol>
  <li>
    <p>Build a user access system such that the user has to register to use the service. They’ll need to log in to the app (usually with email address and password) on each of their devices.</p>
  </li>
  <li>
    <p>Use CloudKit to store all of the information in an Apple provided database.</p>
  </li>
</ol>

<p>The first option is overkill for this fairly simple app<sup id="fnref:overkill"><a href="#fn:overkill" class="footnote">1</a></sup> and the second is too restrictive as it means I need to use Apple’s specific data modelling system. However, there is a third way which uses a bit of each of them…</p>

<p>When a user is logged in to an Apple account on their device<sup id="fnref:appleaccount"><a href="#fn:appleaccount" class="footnote">2</a></sup>, they are automatically signed into the iCloud system. With CloudKit, every app gets its own identifier based on both the CloudKit container and user account which doesn’t change. By retrieving this identifier, you can be 100% sure of the user that is using your app without knowing anything personal about them and without requiring them to manually log into your app.</p>

<p>To get the identifier, you first need to enable CloudKit within the iCloud section of the Capabilities panel in Xcode (which will require updating your provisioning profile). Then, it is a simple case of importing the CloudKit framework and using the following code:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="kd">let</span> <span class="nv">container</span> <span class="p">=</span> <span class="bp">CKContainer</span><span class="p">.</span><span class="n">defaultContainer</span><span class="p">()</span>
<span class="n">container</span><span class="p">.</span><span class="n">fetchUserRecordIDWithCompletionHandler</span> <span class="p">{</span> <span class="p">(</span><span class="n">recordID</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">recordID</span> <span class="p">=</span> <span class="n">recordID</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">\(</span><span class="n">error</span><span class="s">&quot;)</span>
<span class="s">        return</span>
<span class="s">    }</span>
<span class="s">    </span>
<span class="s">    NSLog(&quot;</span><span class="n">Identifier</span><span class="p">:</span> <span class="err">\</span><span class="si">(</span><span class="n">recordID</span><span class="p">.</span><span class="n">recordName</span><span class="si">)</span><span class="s">&quot;)    </span>
<span class="s">}</span></code></pre></figure>

<p>The identifier returned will be 34 characters long and look something like this:</p>

<p><code>_e990774f93dd6625b11af6d40fceb310</code></p>

<p>Once you have that, you can then send it to your server to match it against whatever content you want to link to this particular user. Now whenever they use your app on any device with the same Apple account, they’ll have access to everything without the need for a manual account creation process and without having to hand over any personal information. The entire process is completely silent and is very secure as the identifier is generated from both the Apple account and your CloudKit container - it can’t be used by other apps nor can it be reverse-engineered to give you personal details of the user.</p>

<p>I find the code above a bit messy to be used multiple times throughout an application (not to mention the <code>import CloudKit</code> requirement) and so I’ve wrapped this up in a very basic Swift class that can be called as such:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="n">AppleCloudIdentifier</span><span class="p">.</span><span class="n">fetch</span> <span class="p">{</span> <span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">identifier</span> <span class="p">=</span> <span class="n">identifier</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    
    <span class="n">NSLog</span><span class="p">(</span><span class="s">&quot;Cloud identifier: </span><span class="si">\(</span><span class="n">identifier</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>I’ve named it <code>AppleCloudIdentifier</code> and the code is <a href="https://github.com/bendodson/AppleCloudIdentifier">available on GitHub</a>.</p>

<div class="footnotes">
  <ol>
    <li id="fn:overkill">
      <p>It’ll also lead to a sharp drop-off in users as people don’t like having to create multiple accounts all over the place. You could implement something like Facebook Login but then you still have an issue in that you are requiring a fair amount of personal information upfront which you probably don’t need. <a href="#fnref:overkill" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:appleaccount">
      <p>I’ll hazard a guess that 99.9% of iOS devices are logged into an Apple account. They need to be in order to download apps, send iMessages, create backups, etc, so very unlikely you wouldn’t be. <a href="#fnref:appleaccount" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/06/15/divide-14-wwdc-2016-itunes-with-tabs/">The Divide #14 - WWDC 2016, 'iTunes with tabs'</a></h1>
			
			<time datetime="2016-06-15" pubdate=""><a href="/weblog/2016/06/15/divide-14-wwdc-2016-itunes-with-tabs/">June 15, 2016</a></time>
    	</header>
    	<div>
			<p>The <a href="http://thedivide.co.uk/episodes/14">14th episode of The Divide podcast</a> is now available in which we take look at the new announcements about watchOS, tvOS, macOS, and iOS in a special episode almost as long as the WWDC keynote itself. We also have a brief chat about the latest news from E3 and Chris gets upset about the Stay Puft Marshmallow Man.</p>

<p>You can get The Divide from these fine outlets:</p>

<ul>
  <li><a href="https://itunes.apple.com/gb/podcast/the-divide/id1063410638">iTunes</a></li>
  <li><a href="https://overcast.fm/itunes1063410638/the-divide">Overcast</a></li>
  <li><a href="http://thedivide.co.uk/shows/itunes.xml">RSS</a> (for other podcast readers)</li>
  <li><a href="http://thedivide.co.uk/">The Divide website</a></li>
</ul>

<p>Don’t forget to leave a review on iTunes and follow us on Twitter via <a href="http://twitter.com/PodcastDivide">@PodcastDivide</a>.</p>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/06/07/ios-10-wishlist/">iOS 10 Wishlist</a></h1>
			
			<time datetime="2016-06-07" pubdate=""><a href="/weblog/2016/06/07/ios-10-wishlist/">June 07, 2016</a></time>
    	</header>
    	<div>
			<p>I was recently interviewed by Fast Company for an article they wrote about iOS features they’d like to see at WWDC this year. A couple of my suggestions were <a href="http://www.fastcompany.com/3060377/wwdc/10-ios-features-wed-love-to-see-apple-announce-at-wwdc">featured in the article</a> but I thought I’d publish my full iOS 10 wishlist.</p>

<h3 id="system-defaults">System Defaults</h3>
<p>One of the things that I feel has been long missing from iOS is the ability to choose a default app for certain tasks such as email, web browser, phone, or notes. I would love to see a way for developers to make their app conform to some set of standards that would allow them to be selected as a default app. For example, Skype could conform to the “phone app” standard so when you tap a phone number in your mail app it’ll launch Skype and dial the number rather than using the Phone app. Similarly, email links could go to Polymail and web links to Chrome.</p>

<h3 id="siri-api">Siri API</h3>
<p>I’ve long wanted a full API for Siri but so far there hasn’t even been a stepping stone. I imagine the first phase would go hand in hand with the System Defaults plan I outlined and that apps that adopt a certain standard would be able to show up in Siri. For example, if Spotify conformed to being a “music app” then saying “<em>Hey Siri, Play C’est La Via by B*Witched</em>” would start that track playing in Spotify rather than Music.</p>

<h3 id="control-center-buttons">Control Center Buttons</h3>
<p>When you swipe up from the bottom of the screen on iOS, you get Control Center which gives you quick access to certain features (like WiFi), controls (for music / video), and apps (Torch, Timer, etc). I’d like the ability to a) use 3D touch to get more options when using the features section (so I can choose a new WiFi network) and b) be able to choose the apps and features that show up in that area. I never need quick access to the calculator.</p>

<h3 id="carplay">CarPlay</h3>
<p>I’ve been using CarPlay for around a year now (via an after market <a href="http://www.alpine.co.uk/p/Products/digital-media-receiver-4660/ilx-700">Alpine iLX-700</a>) and I absolutely love it. However, 3rd party apps are limited to a few selected audio apps like Spotify and Overcast which use a simple template that doesn’t work very well. I’d like to see support for any 3rd party app to use CarPlay and for it to use UIKit so that any interface can be displayed. <a href="https://twitter.com/bendodson/status/712573913977524224">I noticed in March</a> that iOS 9.3 added a <code>UIUserInterfaceIdiom</code> for CarPlay so hopefully this is coming.</p>

<h3 id="airplay">AirPlay</h3>
<p>I have a number of AirPlay devices around the house and one of the things that frustrates me most is that I can’t use Siri to control them. I’d like to be able to say “Hey Siri, play my cooking playlist in the kitchen” and have it just work. I’ve been able to <a href="https://bendodson.com/weblog/2016/05/24/homekit-and-airplay/">hack this functionality together</a> via some Applescript and a fake HomeKit setup on my Mac called Homebridge but it’d be nice to have it built in natively. Also, iTunes on the Mac can AirPlay to multiple speakers at once whereas iOS can’t.</p>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/05/25/divide-13-consoles/">The Divide #13 - Consoles</a></h1>
			
			<time datetime="2016-05-25" pubdate=""><a href="/weblog/2016/05/25/divide-13-consoles/">May 25, 2016</a></time>
    	</header>
    	<div>
			<p>The <a href="http://thedivide.co.uk/episodes/13">13th episode of The Divide podcast</a> is now available in which we discuss video game consoles from our first tentative steps in the 8-bit era to the almost HD consoles of the modern day. We also discuss the Flic button, Day of the Tentacle, the Nvidia GTX 1080, Stellaris, and our predictions for WWDC.</p>

<p>You can get The Divide from these fine outlets:</p>

<ul>
  <li><a href="https://itunes.apple.com/gb/podcast/the-divide/id1063410638">iTunes</a></li>
  <li><a href="https://overcast.fm/itunes1063410638/the-divide">Overcast</a></li>
  <li><a href="http://thedivide.co.uk/shows/itunes.xml">RSS</a> (for other podcast readers)</li>
  <li><a href="http://thedivide.co.uk/">The Divide website</a></li>
</ul>

<p>Don’t forget to leave a review on iTunes and follow us on Twitter via <a href="http://twitter.com/PodcastDivide">@PodcastDivide</a>.</p>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/05/24/homekit-and-airplay/">HomeKit, AirPlay, and controlling iTunes with Siri</a></h1>
			
			<time datetime="2016-05-24" pubdate=""><a href="/weblog/2016/05/24/homekit-and-airplay/">May 24, 2016</a></time>
    	</header>
    	<div>
			<p>A few days ago I wrote an article about <a href="https://bendodson.com/weblog/2016/05/18/using-a-button-with-homekit-scenes/">getting my Flic button to work with HomeKit</a>. Since then, I’ve had a few requests from people wondering how I was getting iTunes to work with HomeKit such that it could start a playlist on some AirPlay speakers. Today I’ve <a href="https://www.npmjs.com/~bendodson#packages">released a couple of HomeBridge plugins to NPM</a> and I’ll detail how I’ve got my system working.</p>

<p>First of all, my entire setup is powered by the awesome <a href="https://github.com/nfarina/homebridge">Homebridge</a> system which I’ve written about <a href="https://www.google.co.uk/#q=site:bendodson.com+homebridge">at great length</a>. I found a plugin from <a href="https://github.com/dansays">Dan Budiac</a> called <a href="https://github.com/dansays/homebridge-applescript">homebridge-applescript</a> which allowed you to run a line of applescript via a system of fake switches (so a different script could be called when the switch is turned on and off). This is great for simple one-liners (like “<code>tell application iTunes to pause</code>”) but I needed something a bit longer for dealing with AirPlay. I <a href="https://github.com/bendodson/homebridge-applescript">forked Dan’s project</a> to create my own Homebridge plugin that would work with a path to an AppleScript file rather than a single line of AppleScript:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
	<span class="nt">&quot;accessory&quot;</span><span class="p">:</span> <span class="s2">&quot;ApplescriptFile&quot;</span><span class="p">,</span>
	<span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Kitchen Music&quot;</span><span class="p">,</span>
	<span class="nt">&quot;on&quot;</span><span class="p">:</span> <span class="s2">&quot;/Users/bendodson/Dropbox/Scripts/kitchenMusic.applescript&quot;</span><span class="p">,</span>
	<span class="nt">&quot;off&quot;</span><span class="p">:</span> <span class="s2">&quot;/Users/bendodson/Dropbox/Scripts/stopMusic.applescript&quot;</span>
<span class="p">}</span></code></pre></figure>

<p>This allowed me to then use my existing <a href="https://bendodson.com/weblog/2016/05/12/airplay-alarm-clock-with-itunes-12/">alarm clock script</a> in order to make iTunes connect to my kitchen speakers and play a specific playlist<sup id="fnref:twoplaylists"><a href="#fn:twoplaylists" class="footnote">1</a></sup> when my “kitchen speakers” switch is turned on and disconnect from AirPlay and pause iTunes when it is turned off.</p>

<p>This worked well but it has a few problems as the music is coming from a Mac in a different room; there is no way to change the volume, skip a track, or do a basic play / pause toggle<sup id="fnref:playpause"><a href="#fn:playpause" class="footnote">2</a></sup> without going upstairs to do it manually on iTunes. After thinking about it for a little while, I was able to get the track skipping and play /pause done fairly easily. First of all, I use the following config:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
    <span class="nt">&quot;accessory&quot;</span><span class="p">:</span> <span class="s2">&quot;ApplescriptFile&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Music Play Pause Control&quot;</span><span class="p">,</span>
    <span class="nt">&quot;on&quot;</span><span class="p">:</span> <span class="s2">&quot;/Users/bendodson/Dropbox/Scripts/playMusic.applescript&quot;</span><span class="p">,</span>
    <span class="nt">&quot;off&quot;</span><span class="p">:</span> <span class="s2">&quot;/Users/bendodson/Dropbox/Scripts/pauseMusic.applescript&quot;</span>
<span class="p">}</span><span class="err">,</span>
<span class="p">{</span>
    <span class="nt">&quot;accessory&quot;</span><span class="p">:</span> <span class="s2">&quot;ApplescriptFile&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Music Track Control&quot;</span><span class="p">,</span>
    <span class="nt">&quot;on&quot;</span><span class="p">:</span> <span class="s2">&quot;/Users/bendodson/Dropbox/Scripts/nextTrack.applescript&quot;</span><span class="p">,</span>
    <span class="nt">&quot;off&quot;</span><span class="p">:</span> <span class="s2">&quot;/Users/bendodson/Dropbox/Scripts/previousTrack.applescript&quot;</span>
<span class="p">}</span></code></pre></figure>

<p><em>I won’t detail the AppleScript for each of these as they are fairly basic.</em></p>

<p>Next, I used the ‘Scenes’ feature of HomeKit to set up named scenes that related to each toggle. For example, “iTunes next track” is a scene that ensures the “Music Track Control” accessory is turned on whereas “iTunes previous track” ensures that accessory is off. The play / pause controls work in a similar way. Once activated, this meant I could say things like “<em>Hey Siri, iTunes next track</em>” or “<em>Hey Siri, pause iTunes</em>”.</p>

<p>Whilst scenes can be incredibly useful due to the ability to use any text you want, they can’t be used for something like volume where you want to use a specific amount<sup id="fnref:volumeamount"><a href="#fn:volumeamount" class="footnote">3</a></sup>. Unfortunately HomeKit doesn’t have the concept of speakers so there isn’t a way to naturally create an accessory that deals with volume so I improvised and created a fake lightbulb that controlled an AppleScript via the brightness property; <a href="https://github.com/bendodson/homebridge-applescript-file-lightbulb">homebridge-applescript-file-lightbulb</a><sup id="fnref:naming"><a href="#fn:naming" class="footnote">4</a></sup>.</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
    <span class="nt">&quot;accessory&quot;</span><span class="p">:</span> <span class="s2">&quot;ApplescriptFileLightbulb&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;iTunes volume&quot;</span><span class="p">,</span>
    <span class="nt">&quot;on&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;off&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;brightness&quot;</span><span class="p">:</span> <span class="s2">&quot;/Users/bendodson/Dropbox/Scripts/volume.applescript&quot;</span>
<span class="p">}</span></code></pre></figure>

<p>The <code>volume.applescript</code> file looks like this:</p>

<figure class="highlight"><pre><code class="language-applescript" data-lang="applescript"><span></span><span class="k">on</span> <span class="nb">run</span> <span class="nv">argv</span>
	<span class="k">set</span> <span class="nv">v</span> <span class="k">to</span> <span class="nb">item</span> <span class="mi">1</span> <span class="k">of</span> <span class="nv">argv</span>
	<span class="nb">activate</span> <span class="nb">application</span> <span class="s2">&quot;iTunes&quot;</span>
	<span class="k">tell</span> <span class="nb">application</span> <span class="s2">&quot;iTunes&quot;</span>
		<span class="k">set</span> <span class="na">sound</span> <span class="na">volume</span> <span class="k">to</span> <span class="nv">v</span>
	<span class="k">end</span> <span class="k">tell</span>
<span class="k">end</span> <span class="nb">run</span></code></pre></figure>

<p>With this in place, I can say “<em>Hey Siri, set iTunes volume to 50%</em>” and it will work. This is because lightbulbs have a brightness setting and Siri interprets “<em>set [name] to [percentage]</em>” as being “<em>change the brightness of this device</em>” just in this case we are hitting an AppleScript with our brightness value.
<img src="https://bendodson.s3.amazonaws.com/weblog/2016/siri-itunes-volume.jpg" width="375" height="375" />
This has been a fun little exercise in trying to hack HomeKit into what I want to use it for. I’m hopeful that iOS 10 will add native support for HomeKit speakers as then this could be done without reverting to AppleScript and I’d be able to stream from my iPhone via Siri but it’s pretty cool for the time being.</p>

<p>You can find both of my Homebridge plugins on <a href="https://www.npmjs.com/~bendodson#packages">NPM</a> and <a href="https://github.com/bendodson/">GitHub</a>.</p>

<div class="footnotes">
  <ol>
    <li id="fn:twoplaylists">
      <p>Actually my own setup has two playlists. I have a playlist for Monday through Saturday with my music but on Sunday my wife gets up first so I have a different playlist for her. The code for that is <code>if weekday of (current date) is Sunday then</code> <a href="#fnref:twoplaylists" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:playpause">
      <p>At first I’d get around this by just using “<em>turn off kitchen music</em>” followed by “<em>turn on kitchen music</em>” as the playlist was shuffled but hardly an ideal solution. <a href="#fnref:playpause" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:volumeamount">
      <p>I could have done the same as the track control AppleScript and had a “iTunes volume up” and “iTunes volume down” scene to increase or decrease by 10% each time but that would be a pain if you wanted to change the volume by a large amount. <a href="#fnref:volumeamount" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:naming">
      <p>I shouldn’t be allowed to name things. <a href="#fnref:naming" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/05/19/great-british-bee-count-2016/">Great British Bee Count 2016</a></h1>
			
			<time datetime="2016-05-19" pubdate=""><a href="/weblog/2016/05/19/great-british-bee-count-2016/">May 19, 2016</a></time>
    	</header>
    	<div>
			<p><a href="https://bendodson.com/weblog/2015/05/01/great-british-bee-count-app/">Last year</a> I worked on rebuilding the <a href="https://itunes.apple.com/gb/app/great-british-bee-count/id880987608?mt=8">Great British Bee Count iPhone app</a> for Friends of the Earth. Today, an updated version of the app has gone live to support this years count which runs from 19th May until 30th June 2016:</p>

<p><img src="https://bendodson.s3.amazonaws.com/weblog/2016/gbbc-2016.jpg" width="800" height="500" /></p>

<p>There are several updates including a redesigned bee picker, more details of the bees, and a list of plants suitable for attracting bees sponsored by Waitrose. The app is also now universal with support for both the iPhone and iPad<sup id="fnref:ipaduniversal"><a href="#fn:ipaduniversal" class="footnote">1</a></sup>.</p>

<p>You can check out the <a href="https://itunes.apple.com/gb/app/great-british-bee-count/id880987608?mt=8">Great British Bee Count on the App Store</a> (it’s free) or <a href="http://www.foe.co.uk/page/join-great-british-bee-count-today">learn more about the bee cause</a>.</p>

<div class="footnotes">
  <ol>
    <li id="fn:ipaduniversal">
      <p>This came about due to a restriction in the App Store. If you search for an iPhone-only app on the iPad, you have to manually select “iPhone-only” when searching which nobody in their right mind does (as iPhone apps run on iPad just fine in a scaled mode). To make it so that searching “Great British Bee Count” on the iPad App Store would show the app, it had to be a universal app but the client didn’t want to have a custom design for the iPad but continue to use the iPhone scaling. There isn’t an elegant way to do that (as turning on Universal mode will cause AutoLayout to treat the iPad like an iPad) so I solved this by writing a custom view controller that would take the iPhone 4s XIB files and then simply scale them upwards with an affine transform. I also added an extra border on the sides that matches the yellow background to avoid the black boxing that the previous version had. This works great on all iPads (including the iPad Pro) but the text on some items is quite blurry on the non-retina iPad 2 due to a bug within the Apple Frameworks; it’s intelligent enough to use the retina imagery so that images look smooth but not on text apparently. <a href="#fnref:ipaduniversal" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

		</div>
	</article>
    
	<article>
		<header>
     		
				<h1><a href="/weblog/2016/05/18/using-a-button-with-homekit-scenes/">Using a physical button (Flic) with HomeKit scenes and triggers</a></h1>
			
			<time datetime="2016-05-18" pubdate=""><a href="/weblog/2016/05/18/using-a-button-with-homekit-scenes/">May 18, 2016</a></time>
    	</header>
    	<div>
			<p>When I started out as a web developer I was fascinated by APIs; the ability to hook into other data sources or update other applications from my own had huge potential that is finally being realised with the Internet of Things<sup id="fnref:stuff"><a href="#fn:stuff" class="footnote">1</a></sup>. It is now possible to write apps that interact with physical objects via such things as <a href="http://ifttt.com/">IFTTT</a> or dedicated APIs for devices like the <a href="https://meethue.com/">Philips Hue</a>. I’ve personally been very interested in the <a href="http://www.apple.com/uk/ios/homekit/">HomeKit initiative</a> from Apple although it hasn’t really taken off yet.</p>

<p>Whilst I have a lot of internet connected devices, I currently own just a single HomeKit-compatible device; an <a href="https://www.elgato.com/en/eve/eve-door-window">Elgato eve door &amp; window</a> that lets me ask Siri if my back door is currently open<sup id="fnref:phrasing"><a href="#fn:phrasing" class="footnote">2</a></sup>. Luckily there is the <a href="https://github.com/nfarina/homebridge">Homebridge</a> project (which I’ve <a href="https://bendodson.com/weblog/2015/12/01/homekit-christmas-tree-with-siri/">written about previously</a>) that allows me to connect all of those together and use them as if they were native HomeKit devices.</p>

<p>Over the past few months, I’ve been <a href="https://bendodson.com/weblog/2016/03/23/homekit-wink-and-canary/">dabbling with HomeKit scenes</a> so that I can control groups of devices all at once like so:</p>

<blockquote>
  <p><strong>Good Morning</strong></p>

  <ul>
    <li>Turns on downstairs lights</li>
    <li>Starts playing my “morning” playlist in kitchen via AirPlay</li>
    <li>Disables security cameras</li>
  </ul>

  <p><strong>Good Night</strong></p>

  <ul>
    <li>Turns off all lights (including bedside table lamp)</li>
    <li>Stops any playing music</li>
    <li>Enables security cameras</li>
  </ul>
</blockquote>

<p>This has been working well but I frequently forget to use scenes as many of these things can be controlled in other ways. For example, I might turn off the downstairs lights with my Hue Dimmer Switch and then turn off the bedside table lamp via the Hue today widget which means I forget to activate the security cameras. The eventual solution I’ve come up with is a simple push button (from <a href="http://flic.io/">Flic</a>) stuck under my bedside table that toggles between my <em>Good Morning</em> and <em>Good Night</em> scenes. In this article, I’ll tell you how I did it!</p>

<p>First of all, you are going to need a <a href="http://flic.io/">Flic</a>. I did a lot of research on “smart buttons” and this one was far and away the best<sup id="fnref:biy"><a href="#fn:biy" class="footnote">3</a></sup>. It’s small, has a changeable battery (that lasts 18 months), looks good, and it has an iOS SDK complete with background Bluetooth LE support so you can wake your app up even if it is inactive. The amount of code necessary to support Flic is ridiculously small; you can take a look at <a href="https://flic.io/partners/developers/ios-tutorial">their iOS tutorial</a> to see it in more detail but essentially you will be kicking your user to the Flic app in order to assign a button to the app. Once you’re back, it’s a simple case of activating a singleton and listening for a <code>manager:didReceiveButtonDown</code> request.</p>

<p>With the button tested and working, I set to work on adding HomeKit support to my app. This is relatively straightforward although you do need to create a dedicated provisioning profile in order to add the necessary entitlements to your project. Within a few minutes, I had a toggle in my app that would toggle between my <em>Good Morning</em> and <em>Good Night</em> scenes. That was when disaster struck; the HomeKit APIs do not work when your app is not in the foreground<sup id="fnref:homekitforeground"><a href="#fn:homekitforeground" class="footnote">4</a></sup>.</p>

<p>This threw me for a little while until I decided that my app would simply have to connect directly to my mac and interface with the Homebridge software that was basically powering everything<sup id="fnref:rebuild"><a href="#fn:rebuild" class="footnote">5</a></sup>. After a quick search, I found <a href="https://github.com/cflurin/homebridge-websocket">Homebridge-websocket</a>, a plugin that basically adds a custom websocket server as a platform to HomeKit. You can create accessories (like a switch) within the websocket server and then you’ll get callbacks when they are turned on and off.</p>

<p>I planned to make use of this via a HomeKit property known as “triggers”. A trigger is basically a way for HomeKit to monitor a specific device for a specific value (i.e. when a switch is “on”). As soon as it sees that value, it will activate a chosen scene. I set this up by creating two new switches within Homebridge-websocket; <code>ws_morning</code> and <code>ws_evening</code>. I then set up two triggers within HomeKit; <code>WebSocket Morning</code> (which triggers the <em>Good Morning</em> scene when the <code>ws_morning</code> switch turns on) and <code>WebSocket Evening</code> (which triggers the <em>Good Night</em> scene when the <code>ws_evening</code> switch turns on). The only change I needed to make to my scenes was to ensure that both <code>ws_morning</code> and <code>ws_evening</code> are set to “off” when either is activated; this ensures that I can always turn them from “off” to “on” and thus cause the trigger.</p>

<p>The final step was to update my iOS app to talk to the websocket server instead of to Homebridge. I found a simple drop-in framework named <a href="https://github.com/daltoniam/Starscream">Starscream</a> which allowed me to connect to the server and send commands which led me to this code for the entire project:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">Starscream</span>

<span class="kd">let</span> <span class="nv">ipAddress</span> <span class="p">=</span> <span class="s">&quot;192.168.1.100:4050&quot;</span>
<span class="kd">let</span> <span class="nv">flicAppKey</span> <span class="p">=</span> <span class="s">&quot;Your-Flic-App-Key&quot;</span>
<span class="kd">let</span> <span class="nv">flicAppSecret</span> <span class="p">=</span> <span class="s">&quot;Your-Flic-App-Secret&quot;</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="bp">UIViewController</span><span class="p">,</span> <span class="n">SCLFlicButtonDelegate</span><span class="p">,</span> <span class="n">SCLFlicManagerDelegate</span><span class="p">,</span> <span class="n">WebSocketDelegate</span> <span class="p">{</span>

    <span class="kd">let</span> <span class="nv">socket</span> <span class="p">=</span> <span class="n">WebSocket</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="bp">NSURL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="s">&quot;ws://</span><span class="si">\(</span><span class="n">ipAddress</span><span class="si">)</span><span class="s">/&quot;</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
    
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="n">socket</span><span class="p">.</span><span class="n">delegate</span> <span class="p">=</span> <span class="kc">self</span>
        <span class="n">SCLFlicManager</span><span class="p">.</span><span class="n">configureWithDelegate</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">defaultButtonDelegate</span><span class="p">:</span> <span class="kc">self</span><span class="p">,</span> <span class="n">appID</span><span class="p">:</span> <span class="n">flicAppKey</span><span class="p">,</span> <span class="n">appSecret</span><span class="p">:</span> <span class="n">flicAppSecret</span><span class="p">,</span> <span class="n">backgroundExecution</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">@IBAction</span> <span class="kd">func</span> <span class="nf">setupFlic</span><span class="p">(</span><span class="n">sender</span><span class="p">:</span> <span class="nb">AnyObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">SCLFlicManager</span><span class="p">.</span><span class="n">sharedManager</span><span class="p">()?.</span><span class="n">grabFlicFromFlicAppWithCallbackUrlScheme</span><span class="p">(</span><span class="s">&quot;sceneControl&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kr">@IBAction</span> <span class="kd">func</span> <span class="nf">toggle</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">socket</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="p">}</span>
    

    <span class="c1">// </span><span class="cs">MARK:</span><span class="c1"> Flic Manager</span>
    
    <span class="kd">func</span> <span class="nf">flicManager</span><span class="p">(</span><span class="n">manager</span><span class="p">:</span> <span class="n">SCLFlicManager</span><span class="p">,</span> <span class="n">didGrabFlicButton</span> <span class="n">button</span><span class="p">:</span> <span class="n">SCLFlicButton</span><span class="p">?,</span> <span class="n">withError</span> <span class="n">error</span><span class="p">:</span> <span class="bp">NSError</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">error</span> <span class="p">=</span> <span class="n">error</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">&quot;ERROR: </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">flicButton</span><span class="p">(</span><span class="n">button</span><span class="p">:</span> <span class="n">SCLFlicButton</span><span class="p">,</span> <span class="n">didReceiveButtonDown</span> <span class="n">queued</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">toggle</span><span class="p">()</span>
    <span class="p">}</span>
    
    
    <span class="c1">// </span><span class="cs">MARK:</span><span class="c1"> Websocket Delegate</span>
    
    <span class="kd">func</span> <span class="nf">websocketDidConnect</span><span class="p">(</span><span class="n">socket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">defaults</span> <span class="p">=</span> <span class="bp">NSUserDefaults</span><span class="p">.</span><span class="n">standardUserDefaults</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nv">last</span> <span class="p">=</span> <span class="n">defaults</span><span class="p">.</span><span class="n">stringForKey</span><span class="p">(</span><span class="s">&quot;last_status&quot;</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nv">name</span> <span class="p">=</span> <span class="bp">last</span> <span class="p">==</span> <span class="s">&quot;ws_morning&quot;</span> <span class="p">?</span> <span class="s">&quot;ws_evening&quot;</span> <span class="p">:</span> <span class="s">&quot;ws_morning&quot;</span>
        <span class="kd">let</span> <span class="nv">params</span> <span class="p">=</span> <span class="p">[</span><span class="s">&quot;topic&quot;</span><span class="p">:</span> <span class="s">&quot;setValue&quot;</span><span class="p">,</span> <span class="s">&quot;payload&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;characteristic&quot;</span><span class="p">:</span> <span class="s">&quot;On&quot;</span><span class="p">,</span> <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="bp">NSNumber</span><span class="p">(</span><span class="n">bool</span><span class="p">:</span> <span class="kc">true</span><span class="p">)]]</span>
        <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="k">try</span><span class="p">!</span> <span class="bp">NSJSONSerialization</span><span class="p">.</span><span class="n">dataWithJSONObject</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="p">.</span><span class="n">PrettyPrinted</span><span class="p">)</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">string</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">NSUTF8StringEncoding</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">socket</span><span class="p">.</span><span class="n">writeString</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="n">socket</span><span class="p">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="n">defaults</span><span class="p">.</span><span class="n">setObject</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="s">&quot;last_status&quot;</span><span class="p">)</span>
            <span class="n">defaults</span><span class="p">.</span><span class="n">synchronize</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">websocketDidDisconnect</span><span class="p">(</span><span class="n">socket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="bp">NSError</span><span class="p">?)</span> <span class="p">{</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">websocketDidReceiveData</span><span class="p">(</span><span class="n">socket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="bp">NSData</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">websocketDidReceiveMessage</span><span class="p">(</span><span class="n">socket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    
<span class="p">}</span></code></pre></figure>

<p><strong>Note: this is just a personal project that I built as quickly as possible. By nature, it is a fairly dirty hack. You shouldn’t write professional apps like this.</strong></p>

<p>With this code in place, I can now press my Flic button (stuck to the underside of my bedside table) and it will toggle between my <em>Good Morning</em> and <em>Good Night</em> scenes. This is the full process of what is going on:</p>

<ul>
  <li>Press the Flic button</li>
  <li>Wakes up the iOS app (if terminated or backgrounded) and hits the <code>toggle</code> function</li>
  <li>App sends a websocket command to the Homebridge-websocket server</li>
  <li>Server turns on a fake switch</li>
  <li>HomeKit notices that the fake switch has been turned on so fires trigger to run appropriate scene</li>
  <li>Scene activates or deactivates various accessories and then switches the fake switch back off ensuring it is ready for next button press</li>
</ul>

<p>This is a long way away from the process I’d envisioned (press button, wake up app, toggle scene with HomeKit API) but it has been a fun challenge finding a way to get it work. I now have a physical button that controls multiple aspects of my home with a single press - it’s pretty cool!</p>

<div class="footnotes">
  <ol>
    <li id="fn:stuff">
      <p>Ugh what a horrible expression. I renamed it the <em>Internet of Stuff</em> on <a href="https://bendodson.com/weblog/2016/01/27/divide-7-mind-missiles-internet-of-stuff/">episode 7 of The Divide</a>. <a href="#fnref:stuff" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:phrasing">
      <p><a href="https://bendodson.s3.amazonaws.com/phrasing.png"><em>Phrasing</em></a> <a href="#fnref:phrasing" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:biy">
      <p>“Why not just build your own with a Raspberry Pi or similar?”. Because I can’t be bothered; the cost of my time to do that is more than the cost of buying an incredibly well put together button that already does exactly what I want. <a href="#fnref:biy" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:homekitforeground">
      <p>Probably for a very good reason, you likely don’t want an app reading information about or controlling your HomeKit devices when you aren’t literally using the app. It’s a bit of a pain though for a simple app like this. I did manage to find a <code>com.apple.developer.homekit.background-mode</code> entitlement but there is no way to generate a provisioning profile that uses it. Maybe Apple will add this in a future version of iOS but I wouldn’t count on it. <a href="#fnref:homekitforeground" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:rebuild">
      <p>Technically, as all of my devices have their own APIs I could have just built my app to directly talk to Hue, Canary, iTunes, etc and rebuild my scenes that way. That idea didn’t sit well with me though as it’d be a lot more work and effectively duplicating what I already have. Similarly, I could have just used the native IFTTT support with the Flic to turn on or off some of my devices but that would add more latency and I don’t want to trust my connected home to something that has to be connected online; the beauty of HomeKit is that it works locally. <a href="#fnref:rebuild" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

		</div>
	</article>
    
	
</section>


<section id="pagination">
     
    	<a href="/weblog/page/5/" title="Previous Page" class="pagination-previous">&laquo; Older Entries</a>
     
	
    
      
      	<a href="/weblog/page/3/" title="Next Page" class="pagination-next">Newer Entries &raquo; </a>
      
    
</section>

		
		<footer>
			<p>I perform all freelance work through my company <strong>Dodo Apps Ltd</strong> (07856552) registered at The Bristol Office, 2nd Floor, 5 High Street, Westbury on Trym, Bristol, England, BS9 3BY</p>
		</footer>

	</div>


</body>
</html>